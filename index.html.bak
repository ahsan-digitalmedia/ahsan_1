<!doctype html>
<html lang="id" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Administrasi Guru SD Negeri 1 Poncowati</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap"
    rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .glass-dark {
      background: rgba(0, 102, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    /* Morphing Transitions */
    .morph-transition {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .morph-scale {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
    }

    .morph-scale:hover {
      transform: scale(1.02) translateY(-2px);
    }

    /* Card Gradients */
    .gradient-blue {
      background: linear-gradient(135deg, #0066FF 0%, #00D4FF 100%);
    }

    .gradient-purple {
      background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%);
    }

    .gradient-green {
      background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
    }

    .gradient-orange {
      background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
    }

    .gradient-pink {
      background: linear-gradient(135deg, #EC4899 0%, #F472B6 100%);
    }

    .gradient-cyan {
      background: linear-gradient(135deg, #06B6D4 0%, #22D3EE 100%);
    }

    .gradient-red {
      background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
    }

    /* Sidebar Active */
    .sidebar-item.active {
      background: linear-gradient(135deg, #0066FF 0%, #00D4FF 100%);
      color: white;
    }

    .sidebar-item.active svg {
      color: white;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @media print {
      @page {
        size: portrait;
        margin: 20mm;
      }

      body {
        background: white !important;
        font-family: 'Inter', system-ui, sans-serif !important;
      }

      .no-print {
        display: none !important;
      }

      .print-only {
        display: block !important;
      }

      .print-container {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        color: black !important;
      }

      .print-header {
        border-bottom: 2px solid #1e293b;
        padding-bottom: 15px;
        margin-bottom: 30px;
      }

      .print-section {
        margin-bottom: 25px;
        page-break-inside: avoid;
      }

      .print-section-title {
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 14px;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 8px;
        margin-bottom: 12px;
        color: #1e293b;
      }

      .print-grid {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 13px;
      }

      .print-label {
        font-weight: 600;
        color: #475569;
      }

      .print-value {
        color: #000;
      }

      .signature-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 50px;
        margin-top: 60px;
        page-break-inside: avoid;
      }

      .signature-box {
        text-align: center;
      }

      .signature-space {
        height: 80px;
      }
    }

    .print-only {
      display: none;
    }

    @keyframes pulse-soft {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.5s ease forwards;
    }

    .animate-slideIn {
      animation: slideIn 0.4s ease forwards;
    }

    /* Stagger animations */
    .stagger-1 {
      animation-delay: 0.1s;
    }

    .stagger-2 {
      animation-delay: 0.2s;
    }

    .stagger-3 {
      animation-delay: 0.3s;
    }

    .stagger-4 {
      animation-delay: 0.4s;
    }

    /* Input Focus */
    .input-modern:focus {
      outline: none;
      border-color: #0066FF;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }

    /* Button Hover Effects */
    .btn-primary {
      background: linear-gradient(135deg, #0066FF 0%, #0052CC 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0052CC 0%, #003D99 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 102, 255, 0.4);
    }

    /* Status Badge */
    .status-active {
      background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
    }

    .status-inactive {
      background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      animation: slideIn 0.3s ease;
      z-index: 9999;
      max-width: 400px;
    }

    .toast-success {
      background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
    }

    .toast-error {
      background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
    }

    .toast-warning {
      background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
    }

    /* Page Transitions */
    .page-enter {
      opacity: 0;
      transform: scale(0.98);
    }

    .page-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Modal */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    /* Table */
    .table-row:hover {
      background: linear-gradient(90deg, rgba(0, 102, 255, 0.05) 0%, transparent 100%);
    }

    /* Notification dot */
    .notification-dot {
      animation: pulse-soft 2s infinite;
    }

    /* Score Badge */
    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-weight: bold;
      color: white;
      font-size: 14px;
    }

    .score-excellent {
      background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
    }

    .score-good {
      background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%);
    }

    .score-average {
      background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
    }

    .score-poor {
      background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>

<body class="h-full w-full bg-slate-50 overflow-auto">
  <div id="app" class="h-full w-full"></div>
  <script>
    // Default Configuration
    const defaultConfig = {
      app_title: 'APLIKASI ADMINISTRASI GURU',
      school_name: 'SD NEGERI 1 PONCOWATI',
      primary_color: '#0066FF',
      background_color: '#FFFFFF',
      text_color: '#1E293B',
      surface_color: '#F8FAFC',
      accent_color: '#00D4FF'
    };

    // Application State
    let config = { ...defaultConfig };
    let currentPage = 'login';
    let currentUserType = null; // 'admin' or 'guru'
    let isLoggedIn = false;
    let currentUser = null;
    let teachers = [];
    let assignments = [];
    let students = [];
    let attendances = [];
    let scores = [];
    let teacherAttendances = [];
    let journals = [];
    let modulAjars = [];
    let sidebarOpen = true;
    let showModal = false;
    let modalMode = 'add';
    let editingItem = null;
    let showDeleteConfirm = false;
    let deletingItem = null;
    let selectedDate = new Date().toISOString().split('T')[0];
    let notifications = [
      { id: 1, text: 'Sistem siap digunakan', time: 'baru saja', read: false },
      { id: 2, text: 'Selamat datang di aplikasi guru', time: '1 menit lalu', read: true }
    ];
    let showNotifications = false;
    let isLoading = false;
    let filterSubject = '';
    let currentModulStep = 1;
    const SUBJECT_LIST = [
      'Pendidikan Agama Islam', 'Pendidikan Agama Kristen', 'Pendidikan Agama Katholik',
      'Bahasa Indonesia', 'Bahasa Inggris', 'Pendidikan Pancasila', 'Matematika',
      'IPAS', 'PJOK', 'Bahasa Lampung', 'Seni Rupa', 'Seni Musik', 'KKA'
    ];

    // Toast Notification Function
    function showToast(message, type = 'success', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast-notification toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Data Handler for SDK
    const dataHandler = {
      onDataChanged(data) {
        teachers = data.filter(d => d.type === 'teacher');
        assignments = data.filter(d => d.type === 'assignment');
        students = data.filter(d => d.type === 'student');
        attendances = data.filter(d => d.type === 'attendance');
        scores = data.filter(d => d.type === 'score');
        teacherAttendances = data.filter(d => d.type === 'teacher_attendance');
        journals = data.filter(d => d.type === 'journal');
        modulAjars = data.filter(d => d.type === 'modul_ajar');
        if (currentPage !== 'login' && isLoggedIn) {
          renderCurrentPage();
        }
      }
    };

    // initApp has been moved to the bottom of the file with LocalDataSdk support

    function updateAppTitle() {
      const titleEl = document.getElementById('app-title');
      const schoolEl = document.getElementById('school-name');
      const loginTitleEl = document.getElementById('login-title');
      const loginSchoolEl = document.getElementById('login-school');

      if (titleEl) titleEl.textContent = config.app_title || defaultConfig.app_title;
      if (schoolEl) schoolEl.textContent = config.school_name || defaultConfig.school_name;
      if (loginTitleEl) loginTitleEl.textContent = config.app_title || defaultConfig.app_title;
      if (loginSchoolEl) loginSchoolEl.textContent = config.school_name || defaultConfig.school_name;
    }

    // Generate unique ID
    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Validate email format
    function isValidEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    // Validate NIP (18 digits)
    function isValidNIP(nip) {
      return /^\d{18}$/.test(nip);
    }

    // Validate phone number (Indonesia format)
    function isValidPhone(phone) {
      return /^(62|0)[0-9]{9,12}$/.test(phone);
    }

    // Check if NIP or Email already exists
    function isDuplicateNIP(nip, excludeId = null) {
      return teachers.some(t => t.nip === nip && (!excludeId || t.__backendId !== excludeId));
    }

    function isDuplicateEmail(email, excludeId = null) {
      return teachers.some(t => t.email === email && (!excludeId || t.__backendId !== excludeId));
    }

    // Format date
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('id-ID', options);
    }

    // Get score badge class
    function getScoreBadgeClass(score) {
      if (score >= 85) return 'score-excellent';
      if (score >= 75) return 'score-good';
      if (score >= 60) return 'score-average';
      return 'score-poor';
    }

    // Render function
    function render() {
      const app = document.getElementById('app');
      if (currentPage === 'login') {
        app.innerHTML = renderLoginPage();
        setupLoginHandlers();
      } else {
        if (currentUserType === 'admin') {
          app.innerHTML = renderAdminApp();
        } else if (currentUserType === 'guru') {
          app.innerHTML = renderGuruApp();
        }
        setupMainAppHandlers();
        setupPageHandlers();
        updateSidebarActive();
        updateBreadcrumb();
      }
    }

    function renderCurrentPage() {
      if (currentPage === 'login') return;
      const contentArea = document.getElementById('content-area');
      if (contentArea) {
        contentArea.innerHTML = getPageContent();
      }

      // Also update modals if showModal is true
      const app = document.getElementById('app');
      // If we are in Guru app, we might need to re-render the modal container if it's there
      // But usually render() is better for full state changes.
      // For simple content swaps, this is fine.

      setupPageHandlers();
      updateSidebarActive();
      updateBreadcrumb();

      // If modal is open, we need to ensure its content also stays updated or re-bound
      // However, usually it's cleaner to just call render() for modal-related state changes.
    }

    // Login Page
    function renderLoginPage() {
      return `
        <div class="min-h-full w-full flex items-center justify-center p-4" style="background: linear-gradient(135deg, #0066FF 0%, #00D4FF 50%, #8B5CF6 100%);">
          <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-white/5 rounded-full blur-3xl"></div>
          </div>
          
          <div class="glass w-full max-w-md rounded-3xl shadow-2xl overflow-hidden animate-fadeIn relative z-10">
            <!-- Header -->
            <div class="text-center p-6 pb-4">
              <div class="w-20 h-20 gradient-blue rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </div>
              <h1 id="login-title" class="text-xl font-bold text-slate-800 mb-1">${config.app_title || defaultConfig.app_title}</h1>
              <p id="login-school" class="text-sm text-slate-500">${config.school_name || defaultConfig.school_name}</p>
            </div>
            
            <!-- Tab Navigation -->
            <div class="px-6 pt-2 pb-6">
              <div class="flex gap-2 p-1.5 bg-white/20 rounded-2xl backdrop-blur-md border border-white/30">
                <button id="tab-admin" class="login-tab flex-1 px-4 py-2.5 rounded-xl font-medium text-sm transition-all morph-transition flex items-center justify-center gap-2 active:scale-95"
                  data-type="admin" style="background: rgba(255,255,255,0.9); color: #0066FF;">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  Admin
                </button>
                <button id="tab-guru" class="login-tab flex-1 px-4 py-2.5 rounded-xl font-medium text-sm transition-all morph-transition flex items-center justify-center gap-2 active:scale-95"
                  data-type="guru" style="background: rgba(255,255,255,0.2); color: #9CA3AF;">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                  Guru
                </button>
              </div>
            </div>
            
            <!-- Content -->
            <div class="px-6 pb-6">
              <!-- Admin Login -->
              <form id="login-form" class="space-y-5 login-content" data-type="admin">
                <div class="animate-fadeIn stagger-1" style="opacity: 0;">
                  <label class="block text-sm font-medium text-slate-700 mb-2">Email Admin</label>
                  <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                      </svg>
                    </span>
                    <input type="email" id="login-email" placeholder="admin@sekolah.id" 
                      class="input-modern w-full pl-12 pr-4 py-3 border border-slate-200 rounded-xl bg-white/50 focus:bg-white transition-all" required>
                  </div>
                </div>
                
                <div class="animate-fadeIn stagger-2" style="opacity: 0;">
                  <label class="block text-sm font-medium text-slate-700 mb-2">Kata Sandi</label>
                  <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                      </svg>
                    </span>
                    <input type="password" id="login-password" placeholder="••••••••" 
                       class="input-modern w-full pl-12 pr-4 py-3 border border-slate-200 rounded-xl bg-white/50 focus:bg-white transition-all" required>
                  </div>
                </div>
                
                <div id="login-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm text-center"></div>
                
                <button type="submit" class="btn-primary w-full py-3 rounded-xl text-white font-semibold shadow-lg animate-fadeIn stagger-4 flex items-center justify-center gap-2" style="opacity: 0;">
                  <span id="login-btn-text">Masuk sebagai Admin</span>
                  <span id="login-btn-loading" class="hidden">
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </span>
                </button>
              </form>
              
              <!-- Guru Login -->
              <form id="guru-form" class="space-y-5 login-content hidden" data-type="guru">
                <div class="animate-fadeIn stagger-1" style="opacity: 0;">
                  <label class="block text-sm font-medium text-slate-700 mb-2">Email Guru</label>
                  <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                      </svg>
                    </span>
                    <input type="email" id="guru-email" placeholder="guru@sekolah.id" 
                      class="input-modern w-full pl-12 pr-4 py-3 border border-slate-200 rounded-xl bg-white/50 focus:bg-white transition-all" required>
                  </div>
                </div>
                
                <div class="animate-fadeIn stagger-2" style="opacity: 0;">
                  <label class="block text-sm font-medium text-slate-700 mb-2">Kata Sandi</label>
                  <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                      </svg>
                    </span>
                    <input type="password" id="guru-password" placeholder="••••••••" 
                       class="input-modern w-full pl-12 pr-4 py-3 border border-slate-200 rounded-xl bg-white/50 focus:bg-white transition-all" required>
                  </div>
                </div>
                
                <div id="guru-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm text-center"></div>
                
                <button type="submit" class="btn-primary w-full py-3 rounded-xl text-white font-semibold shadow-lg animate-fadeIn stagger-4 flex items-center justify-center gap-2" style="opacity: 0;">
                  <span id="guru-btn-text">Masuk sebagai Guru</span>
                  <span id="guru-btn-loading" class="hidden">
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </span>
                </button>
              </form>
            </div>
            
            <!-- Demo Info -->
            <div class="px-6 pb-6 pt-4 border-t border-white/20 backdrop-blur-md">
              <div id="demo-info" class="text-xs text-slate-600 bg-white/60 rounded-xl p-3 text-center leading-relaxed">
                <strong>Aplikasi ini dikembangan Oleh Tri Susilo, A.Md</strong><br>
                Admin: admin@sekolah.id / admin123<br>
                Guru: guru@sekolah.id / guru123
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Admin App
    function renderAdminApp() {
      return `
        <div class="h-full w-full flex bg-slate-50">
          <!-- Sidebar -->
          <aside id="sidebar" class="morph-transition ${sidebarOpen ? 'w-64' : 'w-20'} bg-white border-r border-slate-200 flex flex-col h-full shrink-0">
            <!-- Logo -->
            <div class="p-4 border-b border-slate-100">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-blue rounded-xl flex items-center justify-center shadow-md shrink-0">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <div class="${sidebarOpen ? 'block' : 'hidden'} morph-transition">
                  <h1 id="app-title" class="font-bold text-slate-800 text-sm leading-tight">${config.app_title || defaultConfig.app_title}</h1>
                  <p id="school-name" class="text-xs text-slate-500 truncate">${config.school_name || defaultConfig.school_name}</p>
                </div>
              </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
              <button data-page="dashboard" class="sidebar-item ${currentPage === 'dashboard' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Dashboard</span>
              </button>
              
              <button data-page="teachers" class="sidebar-item ${currentPage === 'teachers' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Data Guru</span>
              </button>
              
              <button data-page="reports" class="sidebar-item ${currentPage === 'reports' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Laporan</span>
              </button>
              
              <button data-page="settings" class="sidebar-item ${currentPage === 'settings' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Pengaturan</span>
              </button>
            </nav>
            
            <!-- Toggle Sidebar -->
            <div class="p-3 border-t border-slate-100">
              <button id="toggle-sidebar" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-xl text-slate-500 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 morph-transition ${sidebarOpen ? '' : 'rotate-180'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                </svg>
              </button>
            </div>
          </aside>
          
          <!-- Main Content -->
          <div class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Top Navbar -->
            <header class="bg-white border-b border-slate-200 px-6 py-4 shrink-0">
              <div class="flex items-center justify-between">
                <div>
                  <h2 id="page-title" class="text-lg font-bold text-slate-800">${getPageTitle()}</h2>
                  <div id="breadcrumb" class="flex items-center gap-2 text-sm text-slate-500 mt-0.5">
                    <span>Admin</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span id="breadcrumb-current">${getPageTitle()}</span>
                  </div>
                </div>
                
                <div class="flex items-center gap-4">
                  <!-- Search -->
                  <div class="hidden md:block relative">
                    <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" placeholder="Cari..." class="input-modern pl-10 pr-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white w-64 text-sm">
                  </div>
                  
                  <!-- User Profile -->
                  <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                    <div class="w-10 h-10 gradient-blue rounded-xl flex items-center justify-center text-white font-semibold shadow-md">
                      ${currentUser ? currentUser.name.charAt(0).toUpperCase() : 'A'}
                    </div>
                    <div class="hidden md:block">
                      <p class="text-sm font-semibold text-slate-800">${currentUser ? currentUser.name : 'Administrator'}</p>
                      <p class="text-xs text-slate-500">Admin</p>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-xl hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors" title="Logout">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </header>
            
            <!-- Content Area -->
            <main id="content-area" class="flex-1 overflow-y-auto p-6">
              ${getPageContent()}
            </main>
          </div>
        </div>
        
        <!-- Modal -->
        ${showModal ? renderModal() : ''}
        
        <!-- Delete Confirmation -->
        ${showDeleteConfirm ? renderDeleteConfirm() : ''}
      `;
    }

    // Guru App
    function renderGuruApp() {
      return `
        <div class="h-full w-full flex bg-slate-50">
          <!-- Sidebar -->
          <aside id="sidebar" class="morph-transition ${sidebarOpen ? 'w-64' : 'w-20'} bg-white border-r border-slate-200 flex flex-col h-full shrink-0">
            <!-- Logo -->
            <div class="p-4 border-b border-slate-100">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 gradient-purple rounded-xl flex items-center justify-center shadow-md shrink-0">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <div class="${sidebarOpen ? 'block' : 'hidden'} morph-transition">
                  <h1 id="app-title" class="font-bold text-slate-800 text-sm leading-tight">${config.app_title || defaultConfig.app_title}</h1>
                  <p class="text-xs text-slate-500 truncate">Portal Guru</p>
                </div>
              </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
              <button data-page="guru-dashboard" class="sidebar-item ${currentPage === 'guru-dashboard' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-3m0 0l7-4 7 4M5 9v10a1 1 0 001 1h12a1 1 0 001-1V9m-9 0l9-4m0 0L9.828 4.828a2 2 0 00-2.83.83v.83L3 12"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Dashboard</span>
              </button>
              
              <button data-page="guru-students" class="sidebar-item ${currentPage === 'guru-students' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3.914a3 3 0 01-2.973-2.665A9.969 9.969 0 0112 15c4.744 0 8.268 1.34 9.8 2.646.177.185.332.389.445.617m0 0a9.997 9.997 0 00-7.245-3.263m0 0a3 3 0 105.896 2.228M9 11l3 1m0 0l3-1"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Data Siswa</span>
              </button>
              
              <button data-page="guru-attendance" class="sidebar-item ${currentPage === 'guru-attendance' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Absensi Siswa</span>
              </button>
              
              <button data-page="guru-scores" class="sidebar-item ${currentPage === 'guru-scores' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Nilai Siswa</span>
              </button>
              
              <button data-page="guru-modul-ajar" class="sidebar-item ${currentPage === 'guru-modul-ajar' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Modul Ajar</span>
              </button>
              
              <button data-page="guru-journal" class="sidebar-item ${currentPage === 'guru-journal' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Jurnal Kelas</span>
              </button>
              
              <button data-page="guru-assignments" class="sidebar-item ${currentPage === 'guru-assignments' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Tugas & Nilai</span>
              </button>
              
              <button data-page="guru-profile" class="sidebar-item ${currentPage === 'guru-profile' ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="${sidebarOpen ? 'block' : 'hidden'} font-medium text-sm">Profil</span>
              </button>
            </nav>
            
            <!-- Toggle Sidebar -->
            <div class="p-3 border-t border-slate-100">
              <button id="toggle-sidebar" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-xl text-slate-500 hover:bg-slate-100 transition-all">
                <svg class="w-5 h-5 morph-transition ${sidebarOpen ? '' : 'rotate-180'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                </svg>
              </button>
            </div>
          </aside>
          
          <!-- Main Content -->
          <div class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Top Navbar -->
            <header class="bg-white border-b border-slate-200 px-6 py-4 shrink-0">
              <div class="flex items-center justify-between">
                <div>
                  <h2 id="page-title" class="text-lg font-bold text-slate-800">${getGuruPageTitle()}</h2>
                  <div id="breadcrumb" class="flex items-center gap-2 text-sm text-slate-500 mt-0.5">
                    <span>Guru</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span id="breadcrumb-current">${getGuruPageTitle()}</span>
                  </div>
                </div>
                
                <div class="flex items-center gap-4">
                  <!-- User Profile -->
                  <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                    <div class="w-10 h-10 gradient-purple rounded-xl flex items-center justify-center text-white font-semibold shadow-md">
                      ${currentUser ? currentUser.name.charAt(0).toUpperCase() : 'G'}
                    </div>
                    <div class="hidden md:block">
                      <p class="text-sm font-semibold text-slate-800">${currentUser ? currentUser.name : 'Guru'}</p>
                      <p class="text-xs text-slate-500">${currentUser?.subject || 'Guru'}</p>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-xl hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors" title="Logout">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </header>
            
            <!-- Content Area -->
            <main id="content-area" class="flex-1 overflow-y-auto p-6">
              ${getGuruPageContent()}
            </main>
          </div>
        </div>
        
        <!-- Modal -->
        ${showModal ? renderGuruModal() : ''}
        
        <!-- Delete Confirmation -->
        ${showDeleteConfirm ? renderDeleteConfirm() : ''}
      `;
    }

    function getPageTitle() {
      if (currentUserType === 'guru') {
        return getGuruPageTitle();
      }
      const titles = {
        dashboard: 'Dashboard',
        teachers: 'Manajemen Data Guru',
        reports: 'Laporan',
        settings: 'Pengaturan'
      };
      return titles[currentPage] || 'Dashboard';
    }

    function getGuruPageTitle() {
      const titles = {
        'guru-dashboard': 'Dashboard Utama',
        'guru-students': 'Daftar Siswa',
        'guru-attendance': 'Absensi Siswa',
        'guru-scores': 'Rekap Nilai',
        'guru-modul-ajar': 'Modul Ajar Pembelajaran',
        'guru-journal': 'Jurnal Pembelajaran',
        'guru-assignments': 'Tugas & Evaluasi',
        'guru-profile': 'Profil Saya',
        'guru-teacher-attendance': 'Kehadiran Guru'
      };
      return titles[currentPage] || 'Portal Guru';
    }

    function getPageContent() {
      if (currentUserType === 'admin') {
        switch (currentPage) {
          case 'dashboard': return renderAdminDashboard();
          case 'teachers': return renderTeachersPage();
          case 'reports': return renderReportsPage();
          case 'settings': return renderSettingsPage();
          default: return renderAdminDashboard();
        }
      } else if (currentUserType === 'guru') {
        return getGuruPageContent();
      }
      return '';
    }

    function getGuruPageContent() {
      // Ensure subjects list is available for all renders that need it
      const subjects = SUBJECT_LIST;
      switch (currentPage) {
        case 'guru-dashboard': return renderGuruDashboard();
        case 'guru-students': return renderGuruStudentsPage();
        case 'guru-attendance': return renderGuruAttendancePage();
        case 'guru-scores': return renderGuruScoresPage();
        case 'guru-modul-ajar': return renderModulAjarPage();
        case 'guru-journal': return renderGuruJournalPage();
        case 'guru-assignments': return renderGuruAssignmentsPage();
        case 'guru-profile': return renderGuruProfilePage();
        case 'guru-teacher-attendance': return renderGuruTeacherAttendancePage();
        default: return renderGuruDashboard();
      }
    }

    // Admin Dashboard
    function renderAdminDashboard() {
      const activeTeachers = teachers.filter(t => t.status === 'active').length;
      const inactiveTeachers = teachers.filter(t => t.status === 'inactive').length;

      return `
        <div class="animate-fadeIn">
          <!-- Stats Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="morph-scale gradient-blue rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-1" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Total</span>
              </div>
              <h3 class="text-3xl font-bold">${teachers.length}</h3>
              <p class="text-white/80 text-sm">Total Guru</p>
            </div>
            
            <div class="morph-scale gradient-green rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-2" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Aktif</span>
              </div>
              <h3 class="text-3xl font-bold">${activeTeachers}</h3>
              <p class="text-white/80 text-sm">Guru Aktif</p>
            </div>
            
            <div class="morph-scale gradient-orange rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-3" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Non-aktif</span>
              </div>
              <h3 class="text-3xl font-bold">${inactiveTeachers}</h3>
              <p class="text-white/80 text-sm">Guru Non-aktif</p>
            </div>
            
            <div class="morph-scale gradient-purple rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-4" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Total</span>
              </div>
              <h3 class="text-3xl font-bold">${assignments.length}</h3>
              <p class="text-white/80 text-sm">Total Tugas</p>
            </div>
          </div>
          
          <!-- Bento Grid -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Recent Teachers -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="p-6 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800">Guru Terdaftar Terbaru</h3>
              </div>
              <div class="p-6">
                ${teachers.length === 0 ? `
                  <div class="text-center py-8">
                    <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                      <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                      </svg>
                    </div>
                    <p class="text-slate-500">Belum ada data guru</p>
                    <button class="mt-4 px-4 py-2 btn-primary text-white rounded-xl text-sm" onclick="currentPage='teachers'; showModal=true; modalMode='add'; render();">
                      Tambah Guru Pertama
                    </button>
                  </div>
                ` : `
                  <div class="space-y-4">
                    ${teachers.slice(0, 5).map((teacher, i) => `
                      <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-slate-50 transition-colors">
                        <div class="w-10 h-10 gradient-${['blue', 'purple', 'green', 'orange', 'pink'][i % 5]} rounded-xl flex items-center justify-center text-white font-semibold text-sm">
                          ${teacher.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="font-medium text-slate-800 truncate">${teacher.name}</p>
                          <p class="text-sm text-slate-500 truncate">${teacher.subject || '-'}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-lg ${teacher.status === 'active' ? 'status-active' : 'status-inactive'} text-white">
                          ${teacher.status === 'active' ? 'Aktif' : 'Non-aktif'}
                        </span>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="p-6 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800">Aksi Cepat</h3>
              </div>
              <div class="p-6 space-y-3">
                <button onclick="currentPage='teachers'; showModal=true; modalMode='add'; render();" 
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all group">
                  <div class="w-10 h-10 gradient-blue rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700">Tambah Guru Baru</span>
                </button>
                
                <button onclick="currentPage='teachers'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-purple-300 hover:bg-purple-50 transition-all group">
                  <div class="w-10 h-10 gradient-purple rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700">Lihat Semua Guru</span>
                </button>
                
                <button onclick="currentPage='reports'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-green-300 hover:bg-green-50 transition-all group">
                  <div class="w-10 h-10 gradient-green rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700">Lihat Laporan</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Guru Dashboard - Enhanced with informatif data
    function renderGuruDashboard() {
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const classAttendances = attendances.filter(a => a.attendance_class === currentUser?.class);
      const classScores = scores.filter(s => s.score_teacher_class === currentUser?.class);
      const classJournals = journals.filter(j => (j.type === 'journal' || !j.type) && j.journal_class === currentUser?.class && j.journal_teacher_nip === currentUser?.nip);


      // Get today's attendance data
      const today = new Date().toISOString().split('T')[0];
      const todayAttendances = classAttendances.filter(a => a.attendance_date === today);
      const presentToday = todayAttendances.filter(a => a.attendance_status === 'hadir').length;
      const absentToday = todayAttendances.filter(a => a.attendance_status === 'alpa').length;
      const sickToday = todayAttendances.filter(a => a.attendance_status === 'sakit').length;
      const permitToday = todayAttendances.filter(a => a.attendance_status === 'izin').length;

      // Get attendance stats per day
      const days = {};
      classAttendances.forEach(a => {
        const date = a.attendance_date || today;
        if (!days[date]) {
          days[date] = { total: classStudents.length, present: 0 };
        }
        if (a.attendance_status === 'hadir') {
          days[date].present++;
        }
      });

      const attendanceStats = Object.entries(days).slice(-7).map(([date, data]) => ({
        date: new Date(date).toLocaleDateString('id-ID', { weekday: 'short', month: 'short', day: 'numeric' }),
        percentage: data.total > 0 ? Math.round((data.present / data.total) * 100) : 0
      }));

      const guruAssignments = assignments.filter(a => a.class === currentUser?.class);
      const submittedAssignments = guruAssignments.filter(a => a.score !== undefined && a.score !== null).length;
      const averageScore = guruAssignments.length > 0
        ? Math.round(guruAssignments.filter(a => a.score !== undefined && a.score !== null).reduce((sum, a) => sum + (a.score || 0), 0) / submittedAssignments || 0)
        : 0;

      return `
        <div class="animate-fadeIn">
          <!-- Welcome Card with Quick Info -->
          <div class="gradient-purple rounded-2xl p-8 text-white shadow-lg mb-8 animate-fadeIn stagger-1" style="opacity: 0;">
            <div class="flex items-start justify-between">
              <div>
                <h1 class="text-3xl font-bold mb-2">Selamat Datang, ${currentUser?.name}! 👋</h1>
                <p class="text-purple-100 mb-4">Mata Pelajaran: <strong>${currentUser?.subject}</strong> • Kelas: <strong>${currentUser?.class}</strong></p>
                <div class="flex gap-4 flex-wrap">
                  <div class="flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg">
                    <span class="text-lg">👥</span>
                    <span><strong>${classStudents.length}</strong> Siswa</span>
                  </div>
                  <div class="flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg">
                    <span class="text-lg">📅</span>
                    <span><strong>${classAttendances.length}</strong> Data Absensi</span>
                  </div>
                  <div class="flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg">
                    <span class="text-lg">📝</span>
                    <span><strong>${classJournals.length}</strong> Jurnal</span>
                  </div>
                </div>
              </div>
              <div class="text-6xl">📚</div>
            </div>
          </div>
          
          <!-- Main Stats Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="morph-scale gradient-blue rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-1" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Total</span>
              </div>
              <h3 class="text-3xl font-bold">${classStudents.length}</h3>
              <p class="text-white/80 text-sm">Total Siswa</p>
            </div>
            
            <div class="morph-scale gradient-green rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-2" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Hari Ini</span>
              </div>
              <h3 class="text-3xl font-bold">${presentToday}</h3>
              <p class="text-white/80 text-sm">Siswa Hadir</p>
            </div>
            
            <div class="morph-scale gradient-orange rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-3" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Tidak Hadir</span>
              </div>
              <h3 class="text-3xl font-bold">${absentToday}</h3>
              <p class="text-white/80 text-sm">Siswa Alpa</p>
            </div>
            
            <div class="morph-scale gradient-pink rounded-2xl p-6 text-white shadow-lg animate-fadeIn stagger-4" style="opacity: 0;">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                </div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">Akurat</span>
              </div>
              <h3 class="text-3xl font-bold">${classAttendances.length > 0 ? Math.round((presentToday / classStudents.length) * 100) : 0}%</h3>
              <p class="text-white/80 text-sm">Persentase Hadir Hari Ini</p>
            </div>
          </div>
          
          <!-- Two Column Layout -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Attendance Trend & Biodata -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Attendance Trend -->
              <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                  <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <span>📊</span> Tren Kehadiran Siswa (7 Hari Terakhir)
                  </h3>
                </div>
                <div class="p-6">
                  <div class="space-y-3">
                    ${attendanceStats.length === 0 ? `
                      <p class="text-center text-slate-500 py-4">Belum ada data kehadiran</p>
                    ` : attendanceStats.map(stat => `
                      <div class="flex items-center gap-4">
                        <div class="w-20 text-sm text-slate-600 font-medium">${stat.date}</div>
                        <div class="flex-1">
                          <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                            <div class="h-full gradient-green" style="width: ${stat.percentage}%"></div>
                          </div>
                        </div>
                        <div class="w-12 text-right font-semibold text-slate-800">${stat.percentage}%</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
              
              <!-- Teacher Biodata -->
              <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                  <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                    <span>👨‍🏫</span> Biodata Guru
                  </h3>
                </div>
                <div class="p-6">
                  <div class="flex gap-6">
                    <div class="w-24 h-24 gradient-purple rounded-2xl flex items-center justify-center text-white text-4xl font-bold shrink-0">
                      ${currentUser?.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <p class="text-xs text-slate-500 mb-1">Nama Lengkap</p>
                          <p class="font-semibold text-slate-800">${currentUser?.name}</p>
                        </div>
                        <div>
                          <p class="text-xs text-slate-500 mb-1">NIP</p>
                          <p class="font-semibold text-slate-800">${currentUser?.nip}</p>
                        </div>
                        <div>
                          <p class="text-xs text-slate-500 mb-1">Email</p>
                          <p class="font-semibold text-slate-800 truncate">${currentUser?.email}</p>
                        </div>
                        <div>
                          <p class="text-xs text-slate-500 mb-1">No. Telepon</p>
                          <p class="font-semibold text-slate-800">${currentUser?.phone}</p>
                        </div>
                        <div>
                          <p class="text-xs text-slate-500 mb-1">Mata Pelajaran</p>
                          <p class="font-semibold text-slate-800">${currentUser?.subject}</p>
                        </div>
                        <div>
                          <p class="text-xs text-slate-500 mb-1">Status</p>
                          <span class="inline-flex px-2 py-1 status-active text-white text-xs font-medium rounded-lg">
                            ${currentUser?.status === 'active' ? 'Aktif' : 'Non-aktif'}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quick Access Menu -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="p-6 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                  <span>⚡</span> Akses Cepat
                </h3>
              </div>
              <div class="p-6 space-y-3">
                <button onclick="currentPage='guru-students'; render();" 
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all group text-left">
                  <div class="w-10 h-10 gradient-blue rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3.914a3 3 0 01-2.973-2.665A9.969 9.969 0 0112 15c4.744 0 8.268 1.34 9.8 2.646"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700 text-sm">Lihat Data Siswa</span>
                </button>
                
                <button onclick="currentPage='guru-attendance'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-green-300 hover:bg-green-50 transition-all group text-left">
                  <div class="w-10 h-10 gradient-green rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700 text-sm">Absensi Siswa</span>
                </button>
                
                <button onclick="currentPage='guru-scores'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-orange-300 hover:bg-orange-50 transition-all group text-left">
                  <div class="w-10 h-10 gradient-orange rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700 text-sm">Input Nilai</span>
                </button>
                
                <button onclick="currentPage='guru-journal'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-purple-300 hover:bg-purple-50 transition-all group text-left">
                  <div class="w-10 h-10 gradient-purple rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700 text-sm">Jurnal Kelas</span>
                </button>
                
                <button onclick="currentPage='guru-teacher-attendance'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-cyan-300 hover:bg-cyan-50 transition-all group text-left">
                  <div class="w-10 h-10 gradient-cyan rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700 text-sm">Absen Guru</span>
                </button>

                <button onclick="currentPage='guru-modul-ajar'; render();"
                  class="w-full flex items-center gap-3 p-4 rounded-xl border border-slate-200 hover:border-teal-300 hover:bg-teal-50 transition-all group text-left">
                  <div class="w-10 h-10 gradient-teal rounded-xl flex items-center justify-center text-white group-hover:scale-110 transition-transform shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                  </div>
                  <span class="font-medium text-slate-700 text-sm">Modul Ajar</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-800">Status Kehadiran Hari Ini</h3>
                <span class="text-2xl">📋</span>
              </div>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">Hadir</span>
                  <span class="font-bold text-green-600">${presentToday}/${classStudents.length}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">Alpa</span>
                  <span class="font-bold text-red-600">${absentToday}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">Sakit</span>
                  <span class="font-bold text-yellow-600">${sickToday}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">Izin</span>
                  <span class="font-bold text-blue-600">${permitToday}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-800">Data Siswa</h3>
                <span class="text-2xl">📊</span>
              </div>
              <div class="text-3xl font-bold gradient-blue bg-clip-text text-transparent mb-2">${classStudents.length}</div>
              <p class="text-sm text-slate-500">Siswa Terdaftar</p>
              <button onclick="currentPage='guru-students'; render();" class="mt-4 text-sm text-blue-600 hover:text-blue-700 font-medium">
                Lihat Detail →
              </button>
            </div>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-800">Jurnal Kelas</h3>
                <span class="text-2xl">📝</span>
              </div>
              <div class="text-3xl font-bold gradient-purple bg-clip-text text-transparent mb-2">${classJournals.length}</div>
              <p class="text-sm text-slate-500">Total Jurnal</p>
              <button onclick="currentPage='guru-journal'; render();" class="mt-4 text-sm text-purple-600 hover:text-purple-700 font-medium">
                Lihat Detail →
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Guru Students Page
    function renderGuruStudentsPage() {
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);

      return `
        <div class="animate-fadeIn">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
              <p class="text-slate-500">Kelola data siswa kelas ${currentUser?.class}</p>
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-csv-input" accept=".csv" class="hidden">
              <button id="download-template-btn" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Template
              </button>
              <button id="import-csv-btn" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Import CSV
              </button>
              <button id="add-student-btn" class="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Tambah Siswa
              </button>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nama Siswa</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">NISN</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">NIS</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider hidden md:table-cell">Jenis Kelamin</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider hidden lg:table-cell">Tanggal Lahir</th>
                    <th class="px-6 py-4 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  ${classStudents.length === 0 ? `
                    <tr>
                      <td colspan="6" class="px-6 py-12 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                          </svg>
                        </div>
                        <p class="text-slate-500">Belum ada data siswa</p>
                      </td>
                    </tr>
                  ` : classStudents.map((student, index) => `
                    <tr class="table-row morph-transition">
                      <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 gradient-${['blue', 'purple', 'green', 'orange', 'pink'][index % 5]} rounded-xl flex items-center justify-center text-white font-semibold text-sm shrink-0">
                            ${student.student_name?.charAt(0).toUpperCase() || 'S'}
                          </div>
                          <div>
                            <p class="font-medium text-slate-800">${student.student_name}</p>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 text-sm text-slate-600">${student.student_nisn}</td>
                      <td class="px-6 py-4 text-sm text-slate-600">${student.student_nis || '-'}</td>
                      <td class="px-6 py-4 text-sm text-slate-600 hidden md:table-cell">${student.student_gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                      <td class="px-6 py-4 text-sm text-slate-600 hidden lg:table-cell">${formatDate(student.student_dob)}</td>
                      <td class="px-6 py-4">
                        <div class="flex items-center justify-end gap-2">
                          <button class="edit-student-btn p-2 rounded-lg hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-colors" title="Edit" data-id="${student.id || student.__backendId}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </button>
                          <button class="delete-student-btn p-2 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-600 transition-colors" title="Delete" data-id="${student.id || student.__backendId}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${classStudents.length > 0 ? `
              <div class="px-6 py-4 bg-slate-50 border-t border-slate-200">
                <p class="text-sm text-slate-500">Total ${classStudents.length} siswa terdaftar</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Guru Attendance Page
    function renderGuruAttendancePage() {
      const classAttendances = attendances.filter(a => a.attendance_class === currentUser?.class);
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const today = new Date().toISOString().split('T')[0];
      const viewDate = selectedDate || today;

      return `
        <div class="animate-fadeIn">
          <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4 items-end">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Pilih Tanggal</label>
                <input type="date" id="attendance-date" value="${viewDate}" class="input-modern px-4 py-2.5 border border-slate-200 rounded-xl">
              </div>
              <button id="mark-all-present-btn" class="px-5 py-2.5 rounded-xl border border-green-200 bg-green-50 text-green-700 font-medium hover:bg-green-100 flex items-center gap-2 transition-colors h-fit">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Hadirkan Semua Siswa
              </button>
            </div>
            <div class="flex flex-col md:flex-row gap-2">
              <div class="relative group">
                <button class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 flex items-center gap-2 transition-all">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                  </svg>
                  Cetak Laporan
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 hidden group-hover:block z-50">
                  <button class="print-report-btn w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2" data-type="daily">
                    <span>📅</span> Cetak Harian
                  </button>
                  <button class="print-report-btn w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2" data-type="weekly">
                    <span>📅</span> Cetak Mingguan
                  </button>
                  <button class="print-report-btn w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2" data-type="monthly">
                    <span>📅</span> Cetak Bulanan
                  </button>
                </div>
              </div>
            </div>
            <div class="text-right">
              <span class="text-sm text-slate-500">Menampilkan data untuk: </span>
              <span class="font-semibold text-slate-800">${formatDate(viewDate)}</span>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nama Siswa</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">NISN</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">NIS</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider hidden md:table-cell">JK</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Keterangan</th>
                    <th class="px-6 py-4 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Aksi Presensi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  ${classStudents.length === 0 ? `
                    <tr>
                      <td colspan="6" class="px-6 py-12 text-center text-slate-500">
                        Belum ada data siswa
                      </td>
                    </tr>
                  ` : classStudents.map((student, index) => {
        const studentAttendance = classAttendances.find(a => a.student_id === (student.__backendId || student.id) && a.attendance_date === viewDate);
        const statusColor = {
          'hadir': 'text-green-600 bg-green-50',
          'alpa': 'text-red-600 bg-red-50',
          'sakit': 'text-yellow-600 bg-yellow-50',
          'izin': 'text-blue-600 bg-blue-50'
        };
        const statusLabel = {
          'hadir': 'Hadir',
          'alpa': 'Alpa',
          'sakit': 'Sakit',
          'izin': 'Izin'
        };
        const currentStatus = studentAttendance?.attendance_status || '';

        return `
                      <tr class="table-row morph-transition">
                        <td class="px-6 py-4">
                          <div class="flex items-center gap-3">
                            <div class="w-10 h-10 gradient-${['blue', 'purple', 'green', 'orange', 'pink'][index % 5]} rounded-xl flex items-center justify-center text-white font-semibold text-sm shrink-0">
                              ${student.student_name?.charAt(0).toUpperCase() || 'S'}
                            </div>
                            <p class="font-medium text-slate-800">${student.student_name}</p>
                          </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">${student.student_nisn}</td>
                        <td class="px-6 py-4 text-sm text-slate-600">${student.student_nis || '-'}</td>
                        <td class="px-6 py-4 text-sm text-slate-600 hidden md:table-cell">${student.student_gender || '-'}</td>
                        <td class="px-6 py-4">
                          ${currentStatus ? `
                            <span class="inline-flex px-3 py-1 text-xs font-bold rounded-lg ${statusColor[currentStatus] || 'text-slate-600 bg-slate-50'} uppercase">
                              ${statusLabel[currentStatus]}
                            </span>
                          ` : `
                            <span class="inline-flex px-3 py-1 text-xs font-bold rounded-lg text-slate-400 bg-slate-50 uppercase">
                              Belum Absen
                            </span>
                          `}
                        </td>
                        <td class="px-6 py-4">
                          <div class="flex items-center justify-end gap-1">
                            <button class="set-attendance-btn w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold transition-all ${currentStatus === 'hadir' ? 'bg-green-600 text-white scale-110 shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-green-50 hover:text-green-600'}" 
                              data-student-id="${student.__backendId || student.id}" data-status="hadir" title="Hadir">H</button>
                            <button class="set-attendance-btn w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold transition-all ${currentStatus === 'sakit' ? 'bg-yellow-500 text-white scale-110 shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-yellow-50 hover:text-yellow-600'}" 
                              data-student-id="${student.__backendId || student.id}" data-status="sakit" title="Sakit">S</button>
                            <button class="set-attendance-btn w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold transition-all ${currentStatus === 'izin' ? 'bg-blue-500 text-white scale-110 shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-blue-50 hover:text-blue-600'}" 
                              data-student-id="${student.__backendId || student.id}" data-status="izin" title="Izin">I</button>
                            <button class="set-attendance-btn w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold transition-all ${currentStatus === 'alpa' ? 'bg-red-500 text-white scale-110 shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-600'}" 
                              data-student-id="${student.__backendId || student.id}" data-status="alpa" title="Alpa">A</button>
                          </div>
                        </td>
                      </tr>
                    `;
      }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Guru Scores Page
    function renderGuruScoresPage() {
      let classScores = scores.filter(s => s.score_teacher_class === currentUser?.class);
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const subjects = ['Pendidikan Agama Islam', 'Pendidikan Agama Kristen', 'Pendidikan Agama Katholik', 'Bahasa Indonesia', 'Bahasa Inggris', 'Pendidikan Pancasila', 'Matematika', 'IPAS', 'PJOK', 'Bahasa Lampung', 'Seni Rupa', 'Seni Musik', 'KKA'];

      if (filterSubject) {
        classScores = classScores.filter(s => s.score_subject === filterSubject);
      }

      return `
        <div class="animate-fadeIn">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex gap-2">
                <button id="view-input-btn" class="px-5 py-2.5 rounded-xl border ${modalMode !== 'rekap' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-slate-200 text-slate-600'} font-medium transition-colors">
                  Input Nilai
                </button>
                <button id="view-rekap-btn" class="px-5 py-2.5 rounded-xl border ${modalMode === 'rekap' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-slate-200 text-slate-600'} font-medium transition-colors">
                  Rekap Nilai
                </button>
              </div>
              
              ${modalMode !== 'rekap' ? `
              <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-slate-200">
                <span class="text-xs font-semibold text-slate-500 uppercase">Filter Mapel:</span>
                <select id="score-filter-subject" class="bg-transparent text-sm font-medium text-slate-700 outline-none border-none p-0 cursor-pointer">
                  <option value="">Semua Mapel</option>
                  ${subjects.map(sub => `<option value="${sub}" ${filterSubject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                </select>
              </div>
              ` : ''}
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-score-csv-input" accept=".csv" class="hidden">
              <div class="relative group">
                <button class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 flex items-center gap-2">
                  <span>📥</span> Import
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 hidden group-hover:block z-50">
                  <button id="import-score-csv-btn" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2">
                    <span>📄</span> Import CSV
                  </button>
                  <button id="download-score-template-btn" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2">
                    <span>📜</span> Template CSV
                  </button>
                </div>
              </div>
              <div class="relative group">
                <button class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 flex items-center gap-2">
                  <span>🖨️</span> Cetak
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 hidden group-hover:block z-50">
                  <button class="print-score-btn w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50" data-type="nh">Cetak Nilai Harian</button>
                  <button class="print-score-btn w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50" data-type="mid">Cetak Nilai MID</button>
                  <button class="print-score-btn w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50" data-type="pas">Cetak Nilai PAS</button>
                  <button id="export-excel-btn" class="w-full text-left px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 border-t border-slate-50">Download Excel (CSV)</button>
                </div>
              </div>
              <button id="add-score-btn" class="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Input Nilai
              </button>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            ${modalMode === 'rekap' ? renderGuruScoresRekapView() : `
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                      <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nama Siswa</th>
                      <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Mata Pelajaran</th>
                      <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Formatif</th>
                      <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Sumatif</th>
                      <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">MID</th>
                      <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">PAS</th>
                      <th class="px-6 py-4 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider font-bold">Raport</th>
                      <th class="px-6 py-4 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  ${classScores.length === 0 ? `
                    <tr>
                      <td colspan="9" class="px-6 py-12 text-center">
                        <p class="text-slate-500">Belum ada data nilai</p>
                      </td>
                    </tr>
                  ` : classScores.map((score, index) => {
        const student = classStudents.find(s => (s.__backendId || s.id) === score.student_id);
        return `
                      <tr class="table-row morph-transition">
                        <td class="px-6 py-4">
                          <div class="flex items-center gap-3">
                            <div class="w-10 h-10 gradient-${['blue', 'purple', 'green', 'orange', 'pink'][index % 5]} rounded-xl flex items-center justify-center text-white font-semibold text-sm shrink-0">
                              ${student?.student_name?.charAt(0).toUpperCase() || 'S'}
                            </div>
                            <p class="font-medium text-slate-800">${student?.student_name || 'Tidak Ditemukan'}</p>
                          </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600 font-medium">${score.score_subject}</td>
                        <td class="px-6 py-4 text-center text-sm text-slate-600">${score.score_formatif || 0}</td>
                        <td class="px-6 py-4 text-center text-sm text-slate-600">${score.score_sumatif || 0}</td>
                        <td class="px-6 py-4 text-center text-sm text-slate-600">${score.score_mid || 0}</td>
                        <td class="px-6 py-4 text-center text-sm text-slate-600">${score.score_pas || 0}</td>
                        <td class="px-6 py-4 text-center">
                          <span class="score-badge ${getScoreBadgeClass(score.score_raport || score.score_value)}">${score.score_raport || score.score_value}</span>
                        </td>
                        <td class="px-6 py-4">
                          <div class="flex items-center justify-end gap-2">
                            <button class="edit-score-btn p-2 rounded-lg hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-colors" title="Edit" data-id="${score.__backendId || score.id}">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                              </svg>
                            </button>
                            <button class="delete-score-btn p-2 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors" title="Hapus" data-id="${score.__backendId || score.id}">
                               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                              </svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                    `;
      }).join('')}
                </tbody>
              </table>
            </div>
            `}
          </div>
        </div>
      `;
    }

    function renderGuruScoresRekapView() {
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const subjects = ['Pendidikan Agama Islam', 'Bahasa Indonesia', 'Bahasa Inggris', 'Pendidikan Pancasila', 'Matematika', 'IPAS', 'PJOK', 'Bahasa Lampung', 'Seni Rupa', 'Seni Musik', 'KKA'];

      return `
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th rowspan="2" class="px-3 py-4 text-left font-semibold text-slate-600 uppercase border-r border-slate-200 sticky left-0 bg-slate-50 z-10 w-48">Nama Siswa</th>
                ${subjects.map(sub => `<th colspan="5" class="px-4 py-2 text-center font-semibold text-slate-600 border-r border-slate-200 bg-slate-100">${sub}</th>`).join('')}
              </tr>
              <tr>
                ${subjects.map(() => `
                  <th class="px-1 py-1 text-center font-medium text-slate-500 border-r border-slate-100">F</th>
                  <th class="px-1 py-1 text-center font-medium text-slate-500 border-r border-slate-100">S</th>
                  <th class="px-1 py-1 text-center font-medium text-slate-500 border-r border-slate-100">M</th>
                  <th class="px-1 py-1 text-center font-medium text-slate-500 border-r border-slate-100">P</th>
                  <th class="px-1 py-1 text-center font-bold text-blue-600 border-r border-slate-200 bg-blue-50">R</th>
                `).join('')}
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              ${classStudents.map((student, sIdx) => {
        const studentId = student.__backendId || student.id;
        return `
                  <tr class="hover:bg-slate-50">
                    <td class="px-3 py-3 border-r border-slate-200 sticky left-0 bg-white z-10 font-medium text-slate-800">${student.student_name}</td>
                    ${subjects.map(sub => {
          const score = scores.find(s => s.student_id === studentId && s.score_subject === sub);
          return `
                        <td class="px-1 py-1 text-center border-r border-slate-100 text-slate-600">${score?.score_formatif || '-'}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-100 text-slate-600">${score?.score_sumatif || '-'}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-100 text-slate-600">${score?.score_mid || '-'}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-100 text-slate-600">${score?.score_pas || '-'}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-200 font-bold bg-blue-50/30 text-blue-700">${score?.score_raport || '-'}</td>
                      `;
        }).join('')}
                  </tr>
                `;
      }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Guru Teacher Attendance Page
    function renderGuruTeacherAttendancePage() {
      const myAttendances = teacherAttendances.filter(a => a.teacher_nip === currentUser?.nip);
      const today = new Date().toISOString().split('T')[0];

      return `
        <div class="animate-fadeIn">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
              <p class="text-slate-500">Riwayat kehadiran Anda</p>
            </div>
            <button id="record-teacher-attendance-btn" class="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Catat Kehadiran
            </button>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">📅</span> Status Hari Ini
              </h3>
              ${myAttendances.filter(a => a.teacher_attendance_date === today).length > 0 ? `
                <div class="text-center">
                  <span class="inline-flex px-4 py-2 status-active text-white rounded-lg font-medium">
                    Hadir
                  </span>
                </div>
              ` : `
                <div class="text-center">
                  <span class="inline-flex px-4 py-2 bg-slate-100 text-slate-600 rounded-lg font-medium">
                    Belum Dicatat
                  </span>
                </div>
              `}
            </div>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">📊</span> Total Kehadiran
              </h3>
              <div class="text-3xl font-bold gradient-blue bg-clip-text text-transparent">${myAttendances.length}</div>
              <p class="text-sm text-slate-500 mt-1">Hari masuk</p>
            </div>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">📈</span> Persentase
              </h3>
              <div class="text-3xl font-bold gradient-green bg-clip-text text-transparent">${myAttendances.length > 0 ? Math.round((myAttendances.length / 20) * 100) : 0}%</div>
              <p class="text-sm text-slate-500 mt-1">Kehadiran (dari 20 hari kerja)</p>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Riwayat Kehadiran</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tanggal</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Kelas</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  ${myAttendances.length === 0 ? `
                    <tr>
                      <td colspan="3" class="px-6 py-12 text-center text-slate-500">
                        Belum ada data kehadiran
                      </td>
                    </tr>
                  ` : myAttendances.slice().reverse().map(att => `
                    <tr class="table-row morph-transition">
                      <td class="px-6 py-4 text-sm font-medium text-slate-800">${formatDate(att.teacher_attendance_date)}</td>
                      <td class="px-6 py-4">
                        <span class="inline-flex px-3 py-1 status-active text-white text-sm font-medium rounded-lg">
                          ${att.teacher_attendance_status === 'hadir' ? 'Hadir' : 'Tidak Hadir'}
                        </span>
                      </td>
                      <td class="px-6 py-4 text-sm text-slate-600">${att.teacher_attendance_class || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Modul Ajar Page
    function renderModulAjarPage() {
      const subjects = SUBJECT_LIST;

      // Filter: Show only modules created by the current user (if logged in as guru)
      // Also handle legacy data (no type) or type 'modul_ajar'
      let filteredModuls = modulAjars.filter(m => {
        const isModulType = m.type === 'modul_ajar' || !m.type;
        const belongsToUser = currentUser ? (m.modul_teacher_nip === currentUser.nip) : true;
        return isModulType && belongsToUser;
      });

      if (filterSubject) {
        filteredModuls = filteredModuls.filter(m => m.modul_subject === filterSubject);
      }

      return `
        <div class="animate-fadeIn space-y-6">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-slate-200 shadow-sm">
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Filter Mapel</span>
                <select id="modul-filter-subject" class="bg-transparent text-sm font-medium text-slate-700 outline-none border-none p-0 cursor-pointer focus:ring-0">
                  <option value="">Semua Mata Pelajaran</option>
                  ${subjects.map(sub => `<option value="${sub}" ${filterSubject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                </select>
              </div>
               <div class="px-3 py-2 bg-blue-50 text-blue-700 rounded-xl text-xs font-medium border border-blue-100">
                Total: <strong>${filteredModuls.length}</strong> Modul
              </div>
            </div>
            <button id="add-modul-btn" class="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 shadow-lg hover:shadow-blue-200 transition-all active:scale-95">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              <span>Buat Modul Ajar</span>
            </button>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden ring-1 ring-slate-100">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50/80 backdrop-blur-sm border-b border-slate-200">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Mata Pelajaran & Topik</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Kelas & Fase</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Alokasi Waktu</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Status</th>
                     <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                  ${filteredModuls.length === 0 ? `
                    <tr>
                      <td colspan="5" class="px-6 py-16 text-center">
                        <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 ring-4 ring-slate-50">
                          <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                          </svg>
                        </div>
                        <h3 class="text-slate-800 font-medium mb-1">Belum ada Modul Ajar</h3>
                        <p class="text-slate-400 text-sm max-w-xs mx-auto">Mulai buat modul ajar pertama Anda dengan menekan tombol di atas.</p>
                      </td>
                    </tr>
                  ` : filteredModuls.slice().reverse().map((modul, idx) => `
                    <tr class="table-row group hover:bg-slate-50/80 transition-colors duration-200">
                      <td class="px-6 py-4">
                        <div class="flex items-start gap-3">
                           <div class="w-10 h-10 rounded-lg gradient-${['blue', 'purple', 'green', 'orange'][idx % 4]} flex items-center justify-center text-white font-bold text-lg shrink-0 shadow-sm">
                            ${modul.modul_subject ? modul.modul_subject.charAt(0) : 'M'}
                          </div>
                          <div>
                            <div class="font-semibold text-slate-800">${modul.modul_subject || 'Tanpa Mapel'}</div>
                            <div class="text-sm text-slate-500 mt-0.5 line-clamp-1">${modul.modul_topic || '-'}</div>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="flex flex-col gap-1.5 items-start">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-100">
                            Kelas ${modul.modul_class || '-'}
                          </span>
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-50 text-purple-700 border border-purple-100">
                            Fase ${modul.modul_fase || '-'}
                          </span>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="flex items-center gap-2 text-sm text-slate-600 font-medium">
                          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          ${modul.modul_time_allocation || '-'} JP
                        </div>
                      </td>
                      <td class="px-6 py-4">
                         <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-100">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                            Aktif
                         </span>
                      </td>
                      <td class="px-6 py-4">
                        <div class="flex items-center justify-end gap-2 opacity-100 group-hover:opacity-100 transition-opacity">
                          <button class="download-pdf-btn p-2 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 transition-all shadow-sm" title="Download PDF" data-id="${modul.__backendId || modul.id}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                          </button>
                          <div class="h-8 w-px bg-slate-200 mx-1"></div>
                          <button class="edit-modul-btn p-2 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-orange-600 hover:border-orange-200 hover:bg-orange-50 transition-all shadow-sm" title="Edit Modul" data-id="${modul.__backendId || modul.id}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </button>
                          <button class="delete-modul-btn p-2 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 transition-all shadow-sm" title="Hapus Modul" data-id="${modul.__backendId || modul.id}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        `;
    }

    // Modul Ajar Logic (Handled in setupPageHandlers)
    function copyAiPrompt() {
      const text = document.getElementById(`ai-prompt-text-${currentModulStep}`)?.innerText || '';
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Prompt disalin ke clipboard!', 'success');
      }).catch(err => {
        console.error('Gagal menyalin text: ', err);
      });
    }

    async function downloadModulAjarPDF(id) {
      const modul = modulAjars.find(m => (m.type === 'modul_ajar' || !m.type) && (m.__backendId || m.id) == id);
      if (!modul) return;

      showToast('Menyiapkan PDF...', 'info');

      const element = document.createElement('div');
      element.style.padding = '40px';
      element.style.background = 'white';
      element.style.width = '800px';

      element.innerHTML = `
        <div style="font-family: 'Times New Roman', Times, serif; color: #000; line-height: 1.5;">
          <div style="text-align: center; border-bottom: 3px double #000; margin-bottom: 20px; padding-bottom: 10px;">
            <h2 style="margin: 0; font-size: 18px; font-weight: bold; text-transform: uppercase;">MODUL AJAR KURIKULUM MERDEKA</h2>
            <h3 style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold;">${config.school_name || defaultConfig.school_name}</h3>
            <p style="margin: 5px 0 0 0; font-size: 12px;">Tahun Pelajaran ${new Date().getFullYear()}/${new Date().getFullYear() + 1}</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">A. Identitas Modul</h3>
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
              <tr><td style="width: 150px; padding: 3px 0;">Nama Penyusun</td><td>: ${modul.modul_teacher_name}</td></tr>
              <tr><td style="padding: 3px 0;">NIP</td><td>: ${modul.modul_teacher_nip}</td></tr>
              <tr><td style="padding: 3px 0;">Mata Pelajaran</td><td>: ${modul.modul_subject}</td></tr>
              <tr><td style="padding: 3px 0;">Kelas / Fase</td><td>: ${modul.modul_class} / ${modul.modul_fase}</td></tr>
              <tr><td style="padding: 3px 0;">Topik / Bab</td><td>: ${modul.modul_topic}</td></tr>
              <tr><td style="padding: 3px 0;">Alokasi Waktu</td><td>: ${modul.modul_time_allocation || '-'}</td></tr>
            </table>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">B. Kompetensi Awal & Profil Pelajar Pancasila</h3>
            <div style="margin-bottom: 10px;">
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Identifikasi Sasaran:</p>
              <div style="font-size: 12px; text-align: justify;">${modul.modul_identification || '-'}</div>
            </div>
            <div>
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Dimensi Profil Pelajar Pancasila:</p>
              <ul style="font-size: 12px; margin: 0; padding-left: 20px;">
                ${(modul.modul_dimensions || []).map(dim => `<li>${dim}</li>`).join('')}
              </ul>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">C. Komponen Inti</h3>
            <div style="margin-bottom: 10px;">
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Tujuan Pembelajaran:</p>
              <div style="font-size: 12px; text-align: justify; white-space: pre-line;">${modul.modul_objectives || '-'}</div>
            </div>
            <div style="margin-bottom: 10px;">
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Media Pembelajaran:</p>
              <div style="font-size: 12px; text-align: justify;">${modul.modul_pedagogic || '-'}</div>
            </div>
            <div>
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Langkah-langkah Pembelajaran:</p>
              <div style="font-size: 12px; text-align: justify; white-space: pre-line;">${modul.modul_activities || '-'}</div>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">D. Asesmen & Lampiran</h3>
            <div style="margin-bottom: 10px;">
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Asesmen:</p>
              <div style="font-size: 12px; text-align: justify;">${modul.modul_assessment || '-'}</div>
            </div>
            <div style="margin-bottom: 10px;">
              <p style="font-weight: bold; font-size: 12px; margin-bottom: 3px;">Refleksi:</p>
              <div style="font-size: 12px; text-align: justify;">${modul.modul_reflection || '-'}</div>
            </div>
          </div>

          <div style="margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid;">
            <div style="text-align: center; width: 40%;">
              <p style="font-size: 12px; margin-bottom: 60px;">Mengetahui,<br>Kepala Sekolah</p>
              <p style="font-weight: bold; text-decoration: underline; font-size: 12px;">( ............................................ )</p>
              <p style="font-size: 12px;">NIP. ............................................</p>
            </div>
            <div style="text-align: center; width: 40%;">
              <p style="font-size: 12px; margin-bottom: 60px;">Lampung, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}<br>Guru Mata Pelajaran</p>
              <p style="font-weight: bold; text-decoration: underline; font-size: 12px;">${modul.modul_teacher_name}</p>
              <p style="font-size: 12px;">NIP. ${modul.modul_teacher_nip}</p>
            </div>
          </div>
        </div>
      `;

      const options = {
        margin: 10,
        filename: `Modul_Ajar_${modul.modul_topic.replace(/\s+/g, '_')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      try {
        await html2pdf().set(options).from(element).save();
        showToast('PDF berhasil diunduh', 'success');
      } catch (err) {
        console.error('Gagal generate PDF:', err);
        showToast('Gagal mengunduh PDF', 'error');
      }
    }

    // Setup Login Handlers
    function setupLoginHandlers() {
      const loginForm = document.getElementById('login-form');
      const guruForm = document.getElementById('guru-form');
      const tabAdmin = document.getElementById('tab-admin');
      const tabGuru = document.getElementById('tab-guru');

      if (tabAdmin) {
        tabAdmin.onclick = () => {
          tabAdmin.style.background = 'rgba(255,255,255,0.9)';
          tabAdmin.style.color = '#0066FF';
          tabGuru.style.background = 'rgba(255,255,255,0.2)';
          tabGuru.style.color = '#9CA3AF';
          loginForm.classList.remove('hidden');
          guruForm.classList.add('hidden');
        };
      }

      if (tabGuru) {
        tabGuru.onclick = () => {
          tabGuru.style.background = 'rgba(255,255,255,0.9)';
          tabGuru.style.color = '#0066FF';
          tabAdmin.style.background = 'rgba(255,255,255,0.2)';
          tabAdmin.style.color = '#9CA3AF';
          guruForm.classList.remove('hidden');
          loginForm.classList.add('hidden');
        };
      }

      if (loginForm) {
        loginForm.onsubmit = async (e) => {
          e.preventDefault();
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;

          if (email === 'admin@sekolah.id' && password === 'admin123') {
            currentUser = { name: 'Administrator', email, role: 'admin' };
            currentUserType = 'admin';
            isLoggedIn = true;
            currentPage = 'dashboard';
            render();
          } else {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = 'Email atau password salah!';
            errorEl.classList.remove('hidden');
          }
        };
      }

      if (guruForm) {
        guruForm.onsubmit = async (e) => {
          e.preventDefault();
          const email = document.getElementById('guru-email').value;
          const password = document.getElementById('guru-password').value;

          const teacher = teachers.find(t => t.email === email && t.password === password);
          if (teacher) {
            currentUser = teacher;
            currentUserType = 'guru';
            isLoggedIn = true;
            currentPage = 'guru-dashboard';
            render();
          } else {
            const errorEl = document.getElementById('guru-error');
            errorEl.textContent = 'Email atau password salah!';
            errorEl.classList.remove('hidden');
          }
        };
      }
    }

    // Setup Main App Handlers
    function setupMainAppHandlers() {
      document.querySelectorAll('.sidebar-item').forEach(item => {
        // Use onclick to avoid duplicate listeners and better reliability
        item.onclick = (e) => {
          // If the clicked element is inside the button, the event might bubble up differently
          // but e.currentTarget refers to the button with .sidebar-item class
          currentPage = item.dataset.page;
          render(); // Use render() instead of renderCurrentPage() to ensure full layout update if needed, typically render() handles it all.
          // Or if renderCurrentPage() is sufficient for content swap without full re-render, check if sidebar state needs preserving.
          // Usually valid to just re-render app.
        };
      });

      const toggleBtn = document.getElementById('toggle-sidebar');
      if (toggleBtn) {
        toggleBtn.onclick = () => {
          sidebarOpen = !sidebarOpen;
          render();
        };
      }

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.onclick = () => {
          currentUser = null;
          currentUserType = null;
          isLoggedIn = false;
          currentPage = 'login';
          render();
        };
      }

      if (currentUserType === 'admin') {
        const addTeacherBtn = document.getElementById('add-teacher-btn');
        if (addTeacherBtn) {
          addTeacherBtn.onclick = () => {
            showModal = true;
            modalMode = 'add';
            editingItem = null;
            render();
          };
        }
      }

      setupPageHandlers();
    }

    // Setup Page Handlers
    function setupPageHandlers() {
      if (currentUserType === 'guru') {
        switch (currentPage) {
          case 'guru-modul-ajar': setupModulAjarHandlers(); break;
          case 'guru-students': setupGuruStudentsHandlers(); break;
          case 'guru-attendance': setupGuruAttendanceHandlers(); break;
          case 'guru-scores': setupGuruScoresHandlers(); break;
          case 'guru-journal': setupGuruJournalHandlers(); break;
          case 'guru-assignments': setupGuruAssignmentsHandlers(); break;
          case 'guru-profile': setupGuruProfileHandlers(); break;
          case 'guru-teacher-attendance': setupGuruTeacherAttendanceHandlers(); break;
        }
      } else if (currentUserType === 'admin') {
        setupAdminPageHandlers();
      }
    }

    // Setup Admin Page Handlers
    function setupAdminPageHandlers() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          editingItem = teachers.find(t => (t.__backendId || t.id) == id);
          showModal = true;
          modalMode = 'edit';
          render();
        };
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Apakah Anda yakin ingin menghapus guru ini?')) {
            // Disable button to prevent double clicks
            btn.disabled = true;
            try {
              if (window.dataSdk) {
                await window.dataSdk.delete('teacher', id);
              }
              teachers = teachers.filter(t => (t.__backendId || t.id) != id);
              render();
              showToast('Guru berhasil dihapus', 'success');
            } catch (err) {
              showToast('Gagal menghapus guru', 'error');
              btn.disabled = false;
            }
          }
        };
      });

      const closeModalBtn = document.getElementById('close-modal');
      const cancelModalBtn = document.getElementById('cancel-modal');
      const submitModalBtn = document.getElementById('save-teacher');

      if (closeModalBtn) closeModalBtn.onclick = closeModal;
      if (cancelModalBtn) cancelModalBtn.onclick = closeModal;

      if (submitModalBtn) {
        // Remove existing listener if any (though replacing element usually clears it, checking just in case)
        submitModalBtn.onclick = async () => {
          // Prevent double submission
          if (submitModalBtn.disabled) return;
          submitModalBtn.disabled = true;

          const form = document.getElementById('teacher-form');
          if (!form.checkValidity()) {
            form.reportValidity();
            submitModalBtn.disabled = false;
            return;
          }

          const teacherData = {
            name: document.getElementById('modal-name').value,
            nip: document.getElementById('modal-nip').value,
            class: document.getElementById('modal-class').value,
            email: document.getElementById('modal-email').value,
            phone: document.getElementById('modal-phone').value,
            subject: document.getElementById('modal-subject').value,
            password: document.getElementById('modal-password').value,
            status: document.getElementById('modal-status').value,
            type: 'teacher'
          };

          try {
            if (modalMode === 'add') {
              teacherData.id = generateId();
              if (window.dataSdk) {
                await window.dataSdk.create(teacherData);
              } else {
                console.error("SDK not initialized");
                throw new Error("SDK not initialized");
              }
              // Manual state update
              teachers.push(teacherData);
              showToast('Guru berhasil ditambahkan', 'success');
            } else {
              teacherData.id = editingItem.id || editingItem.__backendId;
              teacherData.__backendId = editingItem.__backendId;
              if (window.dataSdk) {
                await window.dataSdk.update(teacherData);
              }
              // Manual state update
              const index = teachers.findIndex(t => (t.__backendId || t.id) == teacherData.id);
              if (index !== -1) {
                teachers[index] = { ...teachers[index], ...teacherData };
              }
              showToast('Guru berhasil diperbarui', 'success');
            }
            closeModal();
          } catch (err) {
            showToast('Gagal menyimpan data guru', 'error');
            submitModalBtn.disabled = false;
          }
        };
      }
    }

    // Setup Modul Ajar Handlers
    function setupModulAjarHandlers() {
      const addModulBtn = document.getElementById('add-modul-btn');
      if (addModulBtn) {
        addModulBtn.onclick = () => {
          showModal = true;
          modalMode = 'add';
          currentModulStep = 1;
          editingItem = {
            modul_teacher_name: currentUser?.name || '',
            modul_teacher_nip: currentUser?.nip || '',
            modul_dimensions: []
          };
          render();
        };
      }

      document.querySelectorAll('.edit-modul-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          editingItem = modulAjars.find(m => {
            const mId = m.__backendId || m.id;
            return String(mId) === String(id);
          });

          if (editingItem) {
            showModal = true;
            modalMode = 'edit';
            currentModulStep = 1;
            render();
          } else {
            showToast('Gagal menemukan data modul', 'error');
          }
        };
      });

      document.querySelectorAll('.delete-modul-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Apakah Anda yakin ingin menghapus modul ini?')) {
            btn.disabled = true;
            try {
              if (window.dataSdk) {
                await window.dataSdk.delete('modul_ajar', id);
              }
              modulAjars = modulAjars.filter(m => (m.__backendId || m.id) != id);
              render();
              showToast('Modul berhasil dihapus', 'success');
            } catch (err) {
              showToast('Gagal menghapus modul', 'error');
              btn.disabled = false;
            }
          }
        };
      });

      document.querySelectorAll('.download-pdf-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          downloadModulAjarPDF(id);
        };
      });

      const filterSelect = document.getElementById('modul-filter-subject');
      if (filterSelect) {
        filterSelect.addEventListener('change', (e) => {
          filterSubject = e.target.value;
          renderCurrentPage();
        });
      }

      const nextBtn = document.getElementById('next-step-btn');
      const prevBtn = document.getElementById('prev-step-btn');
      const cancelBtn = document.getElementById('cancel-modul-btn');
      const closeBtn = document.getElementById('close-modul-modal');
      const saveModulBtn = document.getElementById('save-modul-btn');

      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (currentModulStep < 4) {
            currentModulStep++;
            render();
          }
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (currentModulStep > 1) {
            currentModulStep--;
            render();
          }
        });
      }

      if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
      if (closeBtn) closeBtn.addEventListener('click', closeModal);

      if (saveModulBtn) {
        // Remove existing listener by using onclick
        saveModulBtn.onclick = async () => {
          if (saveModulBtn.disabled) return;
          saveModulBtn.disabled = true;

          const modulData = {
            modul_subject: document.getElementById('modul-subject').value,
            modul_topic: document.getElementById('modul-topic').value,
            modul_class: document.getElementById('modul-class').value,
            modul_fase: document.getElementById('modul-fase').value,
            modul_time_allocation: document.getElementById('modul-time').value,
            modul_identification: document.getElementById('modul-identification').value,
            modul_dimensions: Array.from(document.querySelectorAll('input[name="dimensions"]:checked')).map(i => i.value),
            modul_objectives: document.getElementById('modul-objectives').value,
            modul_pedagogic: document.getElementById('modul-pedagogic').value,
            modul_activities: document.getElementById('modul-activities').value,
            modul_assessment: document.getElementById('modul-assessment').value,
            modul_reflection: document.getElementById('modul-reflection').value,
            modul_attachments: document.getElementById('modul-attachments').value,
            modul_teacher_name: currentUser?.name || '',
            modul_teacher_nip: currentUser?.nip || '',
            type: 'modul_ajar'
          };

          try {
            if (modalMode === 'add') {
              modulData.id = generateId();
              if (window.dataSdk) {
                await window.dataSdk.create(modulData);
              } else {
                console.error("SDK not initialized");
                throw new Error("SDK not initialized");
              }
              // Manual state update
              modulAjars.push(modulData);
              showToast('Modul berhasil disimpan', 'success');
            } else {
              modulData.id = editingItem.id || editingItem.__backendId;
              modulData.__backendId = editingItem.__backendId;
              if (window.dataSdk) {
                await window.dataSdk.update(modulData);
              }
              // Manual state update
              const index = modulAjars.findIndex(m => (m.__backendId || m.id) == modulData.id);
              if (index !== -1) {
                modulAjars[index] = { ...modulAjars[index], ...modulData };
              }
              showToast('Modul berhasil diperbarui', 'success');
            }
            closeModal();
            render(); // Force update UI
          } catch (err) {
            console.error(err); // helpful for debugging
            showToast('Gagal menyimpan modul', 'error');
            saveModulBtn.disabled = false;
          }
        };
      }
    }

    // Setup Guru Students Handlers
    function setupGuruStudentsHandlers() {
      const addStdBtn = document.getElementById('add-student-btn');
      if (addStdBtn) {
        addStdBtn.onclick = () => {
          showModal = true;
          modalMode = 'add';
          editingItem = null;
          render();
        };
      }

      document.querySelectorAll('.edit-student-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          editingItem = students.find(s => (s.__backendId || s.id) == id);
          showModal = true;
          modalMode = 'edit';
          render();
        };
      });

      document.querySelectorAll('.delete-student-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
            try {
              if (window.dataSdk) {
                await window.dataSdk.delete('student', id);
              }
              students = students.filter(s => (s.__backendId || s.id) != id);
              render();
              showToast('Siswa berhasil dihapus', 'success');
            } catch (err) {
              showToast('Gagal menghapus siswa', 'error');
            }
          }
        };
      });

      const closeStdBtn = document.getElementById('close-student-modal');
      const cancelStdBtn = document.getElementById('cancel-student-modal');
      const saveStdBtn = document.getElementById('save-student-btn');

      if (closeStdBtn) closeStdBtn.onclick = closeModal;
      if (cancelStdBtn) cancelStdBtn.onclick = closeModal;
      if (saveStdBtn) {
        saveStdBtn.onclick = async () => {
          if (saveStdBtn.disabled) return;
          saveStdBtn.disabled = true;

          const form = document.getElementById('student-form');
          if (!form.checkValidity()) {
            form.reportValidity();
            saveStdBtn.disabled = false;
            return;
          }

          const studentData = {
            student_name: document.getElementById('std-name').value,
            student_nisn: document.getElementById('std-nisn').value,
            student_nis: document.getElementById('std-nis').value,
            student_gender: document.getElementById('std-gender').value,
            student_dob: document.getElementById('std-dob').value,
            student_class: currentUser?.class,
            type: 'student'
          };

          try {
            if (modalMode === 'add') {
              studentData.id = generateId();
              if (window.dataSdk) {
                await window.dataSdk.create(studentData);
              }
              students.push(studentData);
              showToast('Siswa berhasil ditambahkan', 'success');
            } else {
              studentData.id = editingItem.id || editingItem.__backendId;
              studentData.__backendId = editingItem.__backendId;
              if (window.dataSdk) {
                await window.dataSdk.update(studentData);
              }
              const idx = students.findIndex(s => (s.__backendId || s.id) == studentData.id);
              if (idx !== -1) students[idx] = { ...students[idx], ...studentData };
              showToast('Siswa berhasil diperbarui', 'success');
            }
            closeModal();
            render();
          } catch (err) {
            showToast('Gagal menyimpan data siswa', 'error');
            saveStdBtn.disabled = false;
          }
        };
      }

      const templateBtn = document.getElementById('download-template-btn');
      if (templateBtn) {
        templateBtn.onclick = downloadStudentTemplate;
      }

      const importBtn = document.getElementById('import-csv-btn');
      const importInput = document.getElementById('import-csv-input');
      if (importBtn && importInput) {
        importBtn.onclick = () => importInput.click();
        importInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) processCSVImport(file);
        };
      }
    }

    // Setup Guru Attendance Handlers
    function setupGuruAttendanceHandlers() {
      const dateInput = document.getElementById('attendance-date');
      const markAllBtn = document.getElementById('mark-all-present-btn');

      if (dateInput) {
        dateInput.onchange = (e) => {
          selectedDate = e.target.value;
          renderCurrentPage();
        };
      }

      if (markAllBtn) {
        markAllBtn.onclick = async () => {
          if (markAllBtn.disabled) return;
          markAllBtn.disabled = true;
          const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
          const date = selectedDate || new Date().toISOString().split('T')[0];

          try {
            for (const s of classStudents) {
              const studentId = s.__backendId || s.id;
              const existing = attendances.find(a => a.student_id === studentId && a.attendance_date === date);
              const data = {
                student_id: studentId,
                attendance_date: date,
                attendance_status: 'hadir',
                attendance_class: currentUser?.class,
                type: 'attendance'
              };

              if (existing) {
                data.id = existing.id || existing.__backendId;
                data.__backendId = existing.__backendId;
                if (window.dataSdk) await window.dataSdk.update(data);
              } else {
                data.id = generateId();
                if (window.dataSdk) await window.dataSdk.create(data);
              }
            }
            showToast('Semua siswa ditandai hadir', 'success');
            render();
          } catch (err) {
            showToast('Gagal memproses absensi', 'error');
            markAllBtn.disabled = false;
          }
        };
      }

      document.querySelectorAll('.set-attendance-btn').forEach(btn => {
        btn.onclick = async () => {
          const studentId = btn.getAttribute('data-student-id');
          const status = btn.getAttribute('data-status');
          const date = selectedDate || new Date().toISOString().split('T')[0];

          const existing = attendances.find(a => a.student_id === studentId && a.attendance_date === date);
          const data = {
            student_id: studentId,
            attendance_date: date,
            attendance_status: status,
            attendance_class: currentUser?.class,
            type: 'attendance'
          };

          try {
            if (existing) {
              data.id = existing.id || existing.__backendId;
              data.__backendId = existing.__backendId;
              if (window.dataSdk) await window.dataSdk.update(data);
              // Update local state for immediate feedback
              const idx = attendances.findIndex(a => (a.__backendId || a.id) == data.id);
              if (idx !== -1) attendances[idx] = { ...attendances[idx], ...data };
            } else {
              data.id = generateId();
              if (window.dataSdk) {
                const res = await window.dataSdk.create(data);
                if (res.isOk) attendances.push(res.data);
              } else {
                attendances.push(data);
              }
            }
            render(); // Trigger re-render for UI update
          } catch (err) {
            showToast('Gagal mencatat absensi', 'error');
          }
        };
      });

      document.querySelectorAll('.print-report-btn').forEach(btn => {
        btn.onclick = () => {
          const type = btn.getAttribute('data-type');
          printAttendanceReport(type);
        };
      });
    }

    // Setup Guru Scores Handlers
    function setupGuruScoresHandlers() {
      const viewInputBtn = document.getElementById('view-input-btn');
      const viewRekapBtn = document.getElementById('view-rekap-btn');

      if (viewInputBtn) {
        viewInputBtn.addEventListener('click', () => {
          modalMode = 'input';
          renderCurrentPage();
        });
      }
      if (viewRekapBtn) {
        viewRekapBtn.addEventListener('click', () => {
          modalMode = 'rekap';
          renderCurrentPage();
        });
      }

      const filterSubjectSelect = document.getElementById('score-filter-subject');
      if (filterSubjectSelect) {
        filterSubjectSelect.addEventListener('change', (e) => {
          filterSubject = e.target.value;
          renderCurrentPage();
        });
      }

      const addBtn = document.getElementById('add-score-btn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          showModal = true;
          modalMode = 'add';
          editingItem = null;
          render();
        });
      }

      document.querySelectorAll('.edit-score-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          editingItem = scores.find(s => (s.__backendId || s.id) == id);
          showModal = true;
          modalMode = 'edit';
          render();
        };
      });

      document.querySelectorAll('.delete-score-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Apakah Anda yakin ingin menghapus nilai ini?')) {
            try {
              if (window.dataSdk) await window.dataSdk.delete('score', id);
              scores = scores.filter(s => (s.__backendId || s.id) != id);
              render();
              showToast('Nilai berhasil dihapus', 'success');
            } catch (err) {
              showToast('Gagal menghapus nilai', 'error');
            }
          }
        };
      });

      // Score Modal Handlers
      const closeScoBtn = document.getElementById('close-score-modal');
      const cancelScoBtn = document.getElementById('cancel-score-modal');
      const saveScoBtn = document.getElementById('save-score-btn');

      if (closeScoBtn) closeScoBtn.onclick = closeModal;
      if (cancelScoBtn) cancelScoBtn.onclick = closeModal;

      // Live Preview Calculation
      const scoreInputs = document.querySelectorAll('.score-input');
      const previewEl = document.getElementById('modal-score-raport-preview');

      function calculateRaport() {
        const f = parseFloat(document.getElementById('modal-score-formatif').value) || 0;
        const s = parseFloat(document.getElementById('modal-score-sumatif').value) || 0;
        const m = parseFloat(document.getElementById('modal-score-mid').value) || 0;
        const p = parseFloat(document.getElementById('modal-score-pas').value) || 0;

        const raport = ((f * 2) + (s * 4) + (m * 2) + (p * 2)) / 10;
        if (previewEl) previewEl.textContent = raport.toFixed(1);
        return raport.toFixed(1);
      }

      scoreInputs.forEach(input => {
        input.oninput = calculateRaport;
      });

      if (saveScoBtn) {
        saveScoBtn.onclick = async () => {
          if (saveScoBtn.disabled) return;
          saveScoBtn.disabled = true;
          const form = document.getElementById('score-form');
          if (!form.checkValidity()) {
            form.reportValidity();
            saveBtn.disabled = false;
            return;
          }

          const studentId = document.getElementById('modal-score-student').value;
          const subject = document.getElementById('modal-score-subject').value;
          const formatif = parseFloat(document.getElementById('modal-score-formatif').value) || 0;
          const sumatif = parseFloat(document.getElementById('modal-score-sumatif').value) || 0;
          const mid = parseFloat(document.getElementById('modal-score-mid').value) || 0;
          const pas = parseFloat(document.getElementById('modal-score-pas').value) || 0;
          const raportScore = calculateRaport();

          const scoreData = {
            student_id: studentId,
            score_subject: subject,
            score_formatif: formatif,
            score_sumatif: sumatif,
            score_mid: mid,
            score_pas: pas,
            score_raport: raportScore,
            score_value: raportScore,
            score_teacher_class: currentUser?.class,
            type: 'score'
          };

          try {
            if (modalMode === 'add') {
              scoreData.id = generateId();
              if (window.dataSdk) await window.dataSdk.create(scoreData);
              scores.push(scoreData);
              showToast('Nilai berhasil disimpan', 'success');
            } else {
              scoreData.id = editingItem.id || editingItem.__backendId;
              scoreData.__backendId = editingItem.__backendId;
              if (window.dataSdk) await window.dataSdk.update(scoreData);
              const idx = scores.findIndex(s => (s.__backendId || s.id) == scoreData.id);
              if (idx !== -1) scores[idx] = { ...scores[idx], ...scoreData };
              showToast('Nilai berhasil diperbarui', 'success');
            }
            closeModal();
            render();
          } catch (err) {
            showToast('Gagal menyimpan nilai', 'error');
            saveBtn.disabled = false;
          }
        };
      }

      // Print, Import, and Export Handlers
      document.querySelectorAll('.print-score-btn').forEach(btn => {
        btn.onclick = () => {
          const type = btn.getAttribute('data-type').toLowerCase();
          printScoreReport(type);
        };
      });

      const importBtn = document.getElementById('import-score-csv-btn');
      const importInput = document.getElementById('import-score-csv-input');
      if (importBtn && importInput) {
        importBtn.onclick = () => importInput.click();
        importInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) processScoreCSVImport(file);
        };
      }

      const tempBtn = document.getElementById('download-score-template-btn');
      if (tempBtn) tempBtn.onclick = downloadScoreTemplate;

      const expBtn = document.getElementById('export-excel-btn');
      if (expBtn) expBtn.onclick = exportScoreToCSV;
    }

    // Setup Guru Journal Handlers
    function setupGuruJournalHandlers() {
      const addBtn = document.getElementById('add-journal-btn');
      if (addBtn) {
        addBtn.onclick = () => {
          showModal = true;
          modalMode = 'add';
          editingItem = null;
          render();
        };
      }

      document.querySelectorAll('.edit-journal-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          editingItem = journals.find(j => (j.__backendId || j.id) == id);
          showModal = true;
          modalMode = 'edit';
          render();
        };
      });

      document.querySelectorAll('.delete-journal-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Apakah Anda yakin ingin menghapus jurnal ini?')) {
            try {
              if (window.dataSdk) await window.dataSdk.delete('journal', id);
              journals = journals.filter(j => (j.__backendId || j.id) != id);
              render();
              showToast('Jurnal berhasil dihapus', 'success');
            } catch (err) {
              showToast('Gagal menghapus jurnal', 'error');
            }
          }
        };
      });

      const closeJouBtn = document.getElementById('close-journal-modal');
      const cancelJouBtn = document.getElementById('cancel-journal-modal');
      const saveJouBtn = document.getElementById('save-journal-btn');

      if (closeJouBtn) closeJouBtn.onclick = closeModal;
      if (cancelJouBtn) cancelJouBtn.onclick = closeModal;
      if (saveJouBtn) {
        saveJouBtn.onclick = async () => {
          if (saveJouBtn.disabled) return;
          saveJouBtn.disabled = true;
          const form = document.getElementById('journal-form');
          if (!form.checkValidity()) {
            form.reportValidity();
            saveJouBtn.disabled = false;
            return;
          }

          const journalData = {
            journal_date: document.getElementById('jou-date').value,
            journal_content: document.getElementById('jou-content').value,
            journal_class: currentUser?.class,
            journal_teacher_nip: currentUser?.nip,
            type: 'journal'
          };

          try {
            if (modalMode === 'add') {
              journalData.id = generateId();
              if (window.dataSdk) await window.dataSdk.create(journalData);
              journals.push(journalData);
              showToast('Jurnal berhasil disimpan', 'success');
            } else {
              journalData.id = editingItem.id || editingItem.__backendId;
              journalData.__backendId = editingItem.__backendId;
              if (window.dataSdk) await window.dataSdk.update(journalData);
              const idx = journals.findIndex(j => (j.__backendId || j.id) == journalData.id);
              if (idx !== -1) journals[idx] = { ...journals[idx], ...journalData };
              showToast('Jurnal berhasil diperbarui', 'success');
            }
            closeModal();
            render();
          } catch (err) {
            showToast('Gagal menyimpan jurnal', 'error');
            saveJouBtn.disabled = false;
          }
        };
      }
    }

    // Setup Guru Assignments Handlers
    function setupGuruAssignmentsHandlers() {
      document.querySelectorAll('.view-assignment-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          alert('Detail tugas ID: ' + id + ' (Fitur ini dalam pengembangan)');
        };
      });

      const filterBtns = ['filter-all', 'filter-pending', 'filter-graded'];
      filterBtns.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.onclick = () => {
            // Implement simple filter logic if needed
            showToast('Filter: ' + id, 'info');
          };
        }
      });
    }

    // Setup Guru Profile Handlers
    function setupGuruProfileHandlers() {
      const changePassBtn = document.getElementById('change-pass-btn');
      if (changePassBtn) {
        changePassBtn.onclick = () => {
          alert('Fitur ubah kata sandi akan segera hadir');
        };
      }
    }

    // Setup Guru Teacher Attendance Handlers
    function setupGuruTeacherAttendanceHandlers() {
      const recordBtn = document.getElementById('record-teacher-attendance-btn');
      if (recordBtn) {
        recordBtn.onclick = async () => {
          if (recordBtn.disabled) return;
          recordBtn.disabled = true;

          const today = new Date().toISOString().split('T')[0];
          const existing = teacherAttendances.find(a => a.teacher_nip === currentUser?.nip && a.teacher_attendance_date === today);

          if (existing) {
            showToast('Anda sudah mencatatkan kehadiran hari ini', 'info');
            recordBtn.disabled = false;
            return;
          }

          const attendanceData = {
            id: generateId(),
            teacher_nip: currentUser?.nip,
            teacher_name: currentUser?.name,
            teacher_attendance_date: today,
            teacher_attendance_time: new Date().toLocaleTimeString(),
            type: 'teacher_attendance'
          };

          try {
            if (window.dataSdk) {
              await window.dataSdk.create(attendanceData);
            }
            teacherAttendances.push(attendanceData);
            showToast('Kehadiran berhasil dicatat', 'success');
            render();
          } catch (err) {
            showToast('Gagal mencatat kehadiran', 'error');
            recordBtn.disabled = false;
          }
        };
      }
    }

    // Render Guru Modal
    function renderGuruModal() {
      switch (currentPage) {
        case 'guru-modul-ajar': return renderModulAjarModal();
        case 'guru-students': return renderStudentModal();
        case 'guru-journal': return renderJournalModal();
        case 'guru-scores': return renderScoreModal();
        default: return '';
      }
    }

    // Render Score Modal
    function renderScoreModal() {
      const score = modalMode === 'edit' ? editingItem : null;
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const subjects = SUBJECT_LIST;

      return `
        <div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fadeIn">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
              <h3 class="text-lg font-semibold text-slate-800">${modalMode === 'edit' ? 'Edit Nilai Siswa' : 'Input Nilai Baru'}</h3>
              <button id="close-score-modal" class="p-2 rounded-xl hover:bg-slate-100 transition-colors">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6">
              <form id="score-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Pilih Siswa *</label>
                  <select id="modal-score-student" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required ${modalMode === 'edit' ? 'disabled' : ''}>
                    <option value="">Pilih Siswa</option>
                    ${classStudents.map(s => `<option value="${s.__backendId || s.id}" ${score?.student_id === (s.__backendId || s.id) ? 'selected' : ''}>${s.student_name}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Mata Pelajaran *</label>
                  <select id="modal-score-subject" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                    <option value="">Pilih Mapel</option>
                    ${subjects.map(sub => `<option value="${sub}" ${score?.score_subject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                  </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nilai Formatif</label>
                    <input type="number" id="modal-score-formatif" value="${score?.score_formatif || ''}" placeholder="0-100" min="0" max="100" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm score-input">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nilai Sumatif</label>
                    <input type="number" id="modal-score-sumatif" value="${score?.score_sumatif || ''}" placeholder="0-100" min="0" max="100" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm score-input">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nilai MID</label>
                    <input type="number" id="modal-score-mid" value="${score?.score_mid || ''}" placeholder="0-100" min="0" max="100" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm score-input">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nilai PAS</label>
                    <input type="number" id="modal-score-pas" value="${score?.score_pas || ''}" placeholder="0-100" min="0" max="100" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm score-input">
                  </div>
                </div>
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-blue-700">Estimasi Nilai Raport:</span>
                    <span id="modal-score-raport-preview" class="text-lg font-bold text-blue-800">${score?.score_raport || '-'}</span>
                  </div>
                  <p class="text-[10px] text-blue-600 mt-1 italic">* Rumus: ((F*2) + (S*4) + (M*2) + (P*2)) / 10</p>
                </div>
              </form>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
              <button id="cancel-score-modal" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">Batal</button>
              <button id="save-score-btn" class="btn-primary px-8 py-2.5 rounded-xl text-white font-medium shadow-lg hover:shadow-blue-200 transition-all">Simpan Nilai</button>
            </div>
          </div>
        </div>
      `;
    }

    // Render Student Modal
    function renderStudentModal() {
      const student = modalMode === 'edit' ? editingItem : null;
      return `
        <div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fadeIn">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
              <h3 class="text-lg font-semibold text-slate-800">${modalMode === 'edit' ? 'Edit Data Siswa' : 'Tambah Siswa Baru'}</h3>
              <button id="close-student-modal" class="p-2 rounded-xl hover:bg-slate-100 transition-colors">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6">
              <form id="student-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap *</label>
                  <input type="text" id="std-name" value="${student?.student_name || ''}" placeholder="Nama lengkap siswa" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">NISN *</label>
                    <input type="text" id="std-nisn" value="${student?.student_nisn || ''}" placeholder="10 digit NISN" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" maxlength="10" required>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">NIS</label>
                    <input type="text" id="std-nis" value="${student?.student_nis || ''}" placeholder="Nomor Induk Siswa" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Jenis Kelamin *</label>
                    <select id="std-gender" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                      <option value="L" ${student?.student_gender === 'L' ? 'selected' : ''}>Laki-laki</option>
                      <option value="P" ${student?.student_gender === 'P' ? 'selected' : ''}>Perempuan</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Tanggal Lahir *</label>
                    <input type="date" id="std-dob" value="${student?.student_dob || ''}" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                  </div>
                </div>
              </form>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
              <button id="cancel-student-modal" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">Batal</button>
              <button id="save-student-btn" class="btn-primary px-8 py-2.5 rounded-xl text-white font-medium shadow-lg hover:shadow-blue-200 transition-all">Simpan Data</button>
            </div>
          </div>
        </div>
      `;
    }

    // Render Journal Modal
    function renderJournalModal() {
      const journal = modalMode === 'edit' ? editingItem : null;
      const today = new Date().toISOString().split('T')[0];
      return `
        <div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fadeIn">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
              <h3 class="text-lg font-semibold text-slate-800">${modalMode === 'edit' ? 'Edit Jurnal' : 'Buat Jurnal Baru'}</h3>
              <button id="close-journal-modal" class="p-2 rounded-xl hover:bg-slate-100 transition-colors">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6">
              <form id="journal-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Tanggal *</label>
                  <input type="date" id="jou-date" value="${journal?.journal_date || today}" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Isi Jurnal / Kegiatan Pembelajaran *</label>
                  <textarea id="jou-content" rows="6" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl text-sm" placeholder="Uraikan kegiatan pembelajaran hari ini..." required>${journal?.journal_content || ''}</textarea>
                </div>
              </form>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
              <button id="cancel-journal-modal" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">Batal</button>
              <button id="save-journal-btn" class="btn-primary px-8 py-2.5 rounded-xl text-white font-medium shadow-lg hover:shadow-blue-200 transition-all">Simpan Jurnal</button>
            </div>
          </div>
        </div>
      `;
    }

    // Render Modul Ajar Modal
    function renderModulAjarModal() {
      const isStep1 = currentModulStep === 1;
      const isStep2 = currentModulStep === 2;
      const isStep3 = currentModulStep === 3;
      const isStep4 = currentModulStep === 4;

      const dimensions = [
        'Beriman, Bertakwa kepada Tuhan YME, dan Berakhlak Mulia',
        'Berkebinekaan Global',
        'Gotong Royong',
        'Mandiri',
        'Bernalar Kritis',
        'Kreatif'
      ];

      return `
        <div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-hidden flex flex-col animate-fadeIn">
            <!-- Modal Header -->
            <div class="p-6 border-b border-slate-100 flex items-center justify-between shrink-0">
              <div>
                <h3 class="text-xl font-bold text-slate-800">${modalMode === 'edit' ? 'Edit Modul Ajar' : 'Buat Modul Ajar Baru'}</h3>
                <p class="text-sm text-slate-500">Langkah ${currentModulStep} dari 4</p>
              </div>
              <button id="close-modul-modal" class="p-2 rounded-xl hover:bg-slate-100 transition-colors">
                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <!-- Progress Bar -->
            <div class="h-1.5 w-full bg-slate-100 shrink-0">
              <div class="h-full gradient-blue transition-all duration-500" style="width: ${currentModulStep * 25}%"></div>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1">
              <form id="modul-ajar-form" class="space-y-6">
                <!-- Step 1: Identitas -->
                <div class="${isStep1 ? 'block' : 'hidden'} space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-semibold text-slate-700 mb-1">Mata Pelajaran *</label>
                      <select id="modul-subject" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl" required>
                        <option value="">Pilih Mapel</option>
                        <option value="Bahasa Indonesia" ${editingItem?.modul_subject === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                        <option value="Matematika" ${editingItem?.modul_subject === 'Matematika' ? 'selected' : ''}>Matematika</option>
                        <option value="IPAS" ${editingItem?.modul_subject === 'IPAS' ? 'selected' : ''}>IPAS</option>
                        <option value="Bahasa Inggris" ${editingItem?.modul_subject === 'Bahasa Inggris' ? 'selected' : ''}>Bahasa Inggris</option>
                        <option value="Pendidikan Pancasila" ${editingItem?.modul_subject === 'Pendidikan Pancasila' ? 'selected' : ''}>Pendidikan Pancasila</option>
                        <option value="PJOK" ${editingItem?.modul_subject === 'PJOK' ? 'selected' : ''}>PJOK</option>
                        <option value="Seni Rupa" ${editingItem?.modul_subject === 'Seni Rupa' ? 'selected' : ''}>Seni Rupa</option>
                        <option value="Seni Musik" ${editingItem?.modul_subject === 'Seni Musik' ? 'selected' : ''}>Seni Musik</option>
                        <option value="Lainnya" ${editingItem?.modul_subject === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-slate-700 mb-1">Topik / Bab *</label>
                      <input type="text" id="modul-topic" value="${editingItem?.modul_topic || ''}" placeholder="Cth: Penjumlahan & Pengurangan" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl" required>
                    </div>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-semibold text-slate-700 mb-1">Kelas *</label>
                      <input type="text" id="modul-class" value="${editingItem?.modul_class || currentUser?.class || ''}" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl" required>
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-slate-700 mb-1">Fase *</label>
                      <select id="modul-fase" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl" required>
                        <option value="A" ${editingItem?.modul_fase === 'A' ? 'selected' : ''}>Fase A (Kelas 1-2)</option>
                        <option value="B" ${editingItem?.modul_fase === 'B' ? 'selected' : ''}>Fase B (Kelas 3-4)</option>
                        <option value="C" ${editingItem?.modul_fase === 'C' ? 'selected' : ''}>Fase C (Kelas 5-6)</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-slate-700 mb-1">Alokasi Waktu *</label>
                      <input type="text" id="modul-time" value="${editingItem?.modul_time_allocation || ''}" placeholder="Cth: 2 x 35 Menit" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl" required>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Sasaran & Dimensi -->
                <div class="${isStep2 ? 'block' : 'hidden'} space-y-4">
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Identifikasi Sasaran / Kompetensi Awal</label>
                    <textarea id="modul-identification" rows="4" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Uraikan kompetensi awal siswa...">${editingItem?.modul_identification || ''}</textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Profil Pelajar Pancasila (Pilih yang sesuai)</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                      ${dimensions.map(dim => `
                        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors">
                          <input type="checkbox" name="dimensions" value="${dim}" ${(editingItem?.modul_dimensions || []).includes(dim) ? 'checked' : ''} class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                          <span class="text-sm text-slate-700">${dim}</span>
                        </label>
                      `).join('')}
                    </div>
                  </div>
                </div>

                <!-- Step 3: Komponen Inti -->
                <div class="${isStep3 ? 'block' : 'hidden'} space-y-4">
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Tujuan Pembelajaran *</label>
                    <textarea id="modul-objectives" rows="4" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Apa yang ingin dicapai melalui pembelajaran ini?">${editingItem?.modul_objectives || ''}</textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Media & Sarana Pembelajaran</label>
                    <textarea id="modul-pedagogic" rows="3" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Alat, bahan, atau media yang digunakan...">${editingItem?.modul_pedagogic || ''}</textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Langkah-langkah Kegiatan Pembelajaran</label>
                    <textarea id="modul-activities" rows="6" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Uraikan kegiatan pendahuluan, inti, dan penutup...">${editingItem?.modul_activities || ''}</textarea>
                  </div>
                </div>

                <!-- Step 4: Evaluasi -->
                <div class="${isStep4 ? 'block' : 'hidden'} space-y-4">
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Asesmen / Penilaian</label>
                    <textarea id="modul-assessment" rows="4" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Bagaimana hasil belajar dinilai?">${editingItem?.modul_assessment || ''}</textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Refleksi Guru & Siswa</label>
                    <textarea id="modul-reflection" rows="3" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Catatan untuk perbaikan pembelajaran...">${editingItem?.modul_reflection || ''}</textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Lampiran (Bahan Bacaan, LKPD, dll)</label>
                    <textarea id="modul-attachments" rows="3" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl" placeholder="Tautan atau daftar lampiran...">${editingItem?.modul_attachments || ''}</textarea>
                  </div>
                </div>
              </form>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-slate-100 flex justify-between items-center shrink-0">
              <div>
                ${currentModulStep > 1 ? `
                  <button id="prev-step-btn" class="px-6 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition-all">Kembali</button>
                ` : ''}
              </div>
              <div class="flex gap-3">
                <button id="cancel-modul-btn" class="px-6 py-2.5 rounded-xl text-slate-400 font-semibold hover:text-slate-600 transition-all">Tutup</button>
                ${currentModulStep < 4 ? `
                  <button id="next-step-btn" class="btn-primary px-8 py-2.5 rounded-xl text-white font-semibold shadow-lg">Lanjut</button>
                ` : `
                  <button id="save-modul-btn" class="btn-primary px-8 py-2.5 rounded-xl text-white font-semibold shadow-lg">Simpan Modul</button>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Render Delete Confirm
    function renderDeleteConfirm() {
      return `
        <div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fadeIn">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Konfirmasi Hapus</h3>
            <p class="text-slate-500 text-center mb-6">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex flex-col gap-2">
              <button id="confirm-delete" class="w-full py-3 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 transition-all">Ya, Hapus Sekarang</button>
              <button id="cancel-delete" class="w-full py-3 rounded-xl border border-slate-200 text-slate-600 font-semibold hover:bg-slate-50 transition-all">Batal</button>
            </div>
          </div>
        </div>
      `;
    }

    // Guru Journal Page
    function renderGuruJournalPage() {
      const classJournals = journals.filter(j => (j.type === 'journal' || !j.type) && j.journal_class === currentUser?.class && j.journal_teacher_nip === currentUser?.nip);


      return `
        <div class="animate-fadeIn">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
              <p class="text-slate-500">Jurnal pembelajaran kelas ${currentUser?.class}</p>
            </div>
            <button id="add-journal-btn" class="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Buat Jurnal Baru
            </button>
          </div>

          <div class="grid grid-cols-1 gap-6">
            ${classJournals.length === 0 ? `
              <div class="text-center py-12 bg-white rounded-2xl shadow-sm border border-slate-200">
                <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
                <p class="text-slate-500 mb-4">Belum ada jurnal</p>
                <button onclick="currentPage='guru-journal'; showModal=true; modalMode='add'; render();" class="inline-flex px-4 py-2 btn-primary text-white rounded-xl">
                  Buat Jurnal Pertama
                </button>
              </div>
            ` : classJournals.slice().reverse().map((journal, i) => `
              <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-all morph-scale animate-fadeIn" style="opacity: 0; animation-delay: ${i * 0.1}s;">
                <div class="p-6">
                  <div class="flex items-start justify-between mb-4">
                    <div>
                      <h3 class="font-semibold text-slate-800 mb-1 flex items-center gap-2">
                        <span class="text-lg">📅</span>
                        ${formatDate(journal.journal_date)}
                      </h3>
                      <p class="text-sm text-slate-500">Kelas ${journal.journal_class}</p>
                    </div>
                  </div>
                  <p class="text-slate-700 line-clamp-3 mb-4 font-medium leading-relaxed">${journal.journal_content}</p>
                  <div class="flex gap-2">
                    <button class="edit-journal-btn px-4 py-2 text-sm border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors" data-id="${journal.__backendId || journal.id}">
                      Edit
                    </button>
                    <button class="delete-journal-btn px-4 py-2 text-sm border border-red-100 text-red-500 rounded-xl hover:bg-red-50 transition-colors" data-id="${journal.__backendId || journal.id}">
                      Hapus
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Teachers Page
    function renderTeachersPage() {
      return `
        <div class="animate-fadeIn">
          <!-- Header -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
              <p class="text-slate-500">Kelola data guru dengan mudah</p>
            </div>
            <button id="add-teacher-btn" class="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Tambah Guru
            </button>
          </div>

          <!-- Table -->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">NIP</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider hidden md:table-cell">Email</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider hidden lg:table-cell">Mapel</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  ${teachers.length === 0 ? `
                    <tr>
                      <td colspan="6" class="px-6 py-12 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                          </svg>
                        </div>
                        <p class="text-slate-500">Belum ada data guru</p>
                        <p class="text-sm text-slate-400 mt-1">Klik tombol "Tambah Guru" untuk membuat akun guru baru</p>
                      </td>
                    </tr>
                  ` : teachers.map((teacher, index) => `
                    <tr class="table-row morph-transition" data-teacher-id="${teacher.__backendId || teacher.id}">
                      <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 gradient-${['blue', 'purple', 'green', 'orange', 'pink'][index % 5]} rounded-xl flex items-center justify-center text-white font-semibold text-sm shrink-0">
                            ${teacher.name.charAt(0).toUpperCase()}
                          </div>
                          <div class="min-w-0">
                            <p class="font-medium text-slate-800 truncate">${teacher.name}</p>
                            <p class="text-sm text-slate-500 truncate md:hidden">${teacher.email}</p>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 text-sm text-slate-600">${teacher.nip}</td>
                      <td class="px-6 py-4 text-sm text-slate-600 hidden md:table-cell">${teacher.email}</td>
                      <td class="px-6 py-4 text-sm text-slate-600 hidden lg:table-cell">${teacher.subject || '-'}</td>
                      <td class="px-6 py-4">
                        <span class="inline-flex px-3 py-1 text-xs font-medium rounded-lg text-white ${teacher.status === 'active' ? 'status-active' : 'status-inactive'}">
                          ${teacher.status === 'active' ? 'Aktif' : 'Non-aktif'}
                        </span>
                      </td>
                      <td class="px-6 py-4">
                        <div class="flex items-center justify-end gap-2">
                          <button class="edit-btn p-2 rounded-lg hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-colors" data-id="${teacher.__backendId || teacher.id}" title="Edit">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </button>
                          <button class="delete-btn p-2 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-600 transition-colors" data-id="${teacher.__backendId || teacher.id}" title="Hapus">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            ${teachers.length > 0 ? `
              <div class="px-6 py-4 bg-slate-50 border-t border-slate-200">
                <p class="text-sm text-slate-500">Total ${teachers.length} data guru terdaftar</p>
              </div>
            ` : ''}
          </div>
      `;
    }

    // Guru Assignments Page
    function renderGuruAssignmentsPage() {
      const guruAssignments = assignments.filter(a => a.class === currentUser?.class);

      return `
      <div class="animate-fadeIn" >
          <!--Filters -->
          <div class="mb-6 flex flex-wrap gap-3">
            <button id="filter-all" class="px-4 py-2 rounded-xl bg-blue-50 text-blue-600 font-medium text-sm border border-blue-200 hover:bg-blue-100 transition-colors">
              Semua (${guruAssignments.length})
            </button>
            <button id="filter-pending" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 font-medium text-sm hover:bg-slate-50 transition-colors">
              Belum Dinilai (${guruAssignments.filter(a => a.score === undefined || a.score === null).length})
            </button>
            <button id="filter-graded" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 font-medium text-sm hover:bg-slate-50 transition-colors">
              Sudah Dinilai (${guruAssignments.filter(a => a.score !== undefined && a.score !== null).length})
            </button>
          </div>

          <!--Assignments Grid-->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        ${guruAssignments.length === 0 ? `
              <div class="lg:col-span-2 text-center py-12">
                <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                </div>
                <p class="text-slate-500">Belum ada tugas untuk kelas Anda</p>
              </div>
            ` : guruAssignments.map((assignment, i) => `
              <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-all morph-scale animate-fadeIn" style="opacity: 0; animation-delay: ${i * 0.1}s;">
                <div class="p-6">
                  <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                      <h3 class="font-semibold text-slate-800 mb-2">${assignment.assignment_title}</h3>
                      <p class="text-sm text-slate-500 line-clamp-2">${assignment.assignment_description || 'Tidak ada deskripsi'}</p>
                    </div>
                    <div class="shrink-0 ml-4">
                      ${assignment.score !== undefined && assignment.score !== null ? `
                        <span class="score-badge ${getScoreBadgeClass(assignment.score)}">${assignment.score}</span>
                      ` : `
                        <span class="inline-flex px-3 py-1 bg-yellow-50 text-yellow-700 text-xs rounded-lg font-medium">Pending</span>
                      `}
                    </div>
                  </div>

                  <div class="space-y-2 mb-4">
                    <div class="flex items-center gap-2 text-sm text-slate-600">
                      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                      <span>Tenggat: ${formatDate(assignment.due_date)}</span>
                    </div>
                    ${assignment.feedback ? `
                      <div class="flex items-start gap-2 text-sm">
                        <svg class="w-4 h-4 text-blue-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-blue-700"><strong>Umpan balik:</strong> ${assignment.feedback}</span>
                      </div>
                    ` : ''}
                  </div>

                  <button class="view-assignment-btn w-full px-4 py-2 rounded-lg border border-slate-200 text-slate-600 font-medium text-sm hover:bg-slate-50 transition-colors" data-id="${assignment.__backendId || assignment.id}">
                    Lihat Detail
                  </button>
                </div>
              </div>
            `).join('')}
      </div>
        </div>
      `;
    }

    // Guru Profile Page
    function renderGuruProfilePage() {
      return `
      <div class="animate-fadeIn max-w-2xl" >
          <!--Profile Card-->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
            <div class="gradient-purple h-32"></div>
            <div class="px-6 pb-6">
              <div class="flex flex-col md:flex-row md:items-end gap-4 -mt-16 mb-6">
                <div class="w-32 h-32 gradient-purple rounded-2xl flex items-center justify-center text-white text-5xl font-bold border-4 border-white shadow-lg">
                  ${currentUser?.name.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1">
                  <h2 class="text-2xl font-bold text-slate-800 mb-1">${currentUser?.name}</h2>
                  <p class="text-slate-600 mb-3">${currentUser?.subject}</p>
                  <span class="inline-flex px-3 py-1 status-active text-white text-sm font-medium rounded-lg">
                    ${currentUser?.status === 'active' ? 'Guru Aktif' : 'Guru Non-aktif'}
                  </span>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="p-4 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-600 mb-1">NIP</p>
                  <p class="font-semibold text-slate-800">${currentUser?.nip}</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-600 mb-1">Kelas</p>
                  <p class="font-semibold text-slate-800">${currentUser?.class}</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl">
                  <p class="text-xs text-slate-600 mb-1">Status</p>
                  <p class="font-semibold text-slate-800">${currentUser?.status === 'active' ? 'Aktif' : 'Non-aktif'}</p>
                </div>
              </div>
            </div>
          </div>

          <!--Contact Information-->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Informasi Kontak</h3>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                <p class="px-4 py-3 bg-slate-50 rounded-xl text-slate-700">${currentUser?.email}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">No. Telepon</label>
                <p class="px-4 py-3 bg-slate-50 rounded-xl text-slate-700">${currentUser?.phone}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Tanggal Bergabung</label>
                <p class="px-4 py-3 bg-slate-50 rounded-xl text-slate-700">${currentUser?.joinDate ? formatDate(currentUser.joinDate) : '-'}</p>
              </div>
            </div>
          </div>

          <!--Statistics -->
          <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div class="text-center">
                <p class="text-3xl font-bold gradient-blue bg-clip-text text-transparent">${assignments.filter(a => a.class === currentUser?.class).length}</p>
                <p class="text-sm text-slate-600 mt-2">Total Tugas</p>
              </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div class="text-center">
                <p class="text-3xl font-bold gradient-green bg-clip-text text-transparent">${assignments.filter(a => a.class === currentUser?.class && a.score !== undefined && a.score !== null).length}</p>
                <p class="text-sm text-slate-600 mt-2">Tugas Dinilai</p>
              </div>
            </div>
          </div>

          <!--Security -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-6 border-b border-slate-100">
          <h3 class="font-semibold text-slate-800">Keamanan</h3>
        </div>
        <div class="p-6">
          <p class="text-slate-600 text-sm mb-4">
            Ubah kata sandi Anda secara berkala untuk menjaga keamanan akun. Hubungi administrator jika Anda lupa kata sandi.
          </p>
          <button id="change-pass-btn" class="px-4 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">
            Ubah Kata Sandi
          </button>
        </div>
      </div>
          </div>
        </div>
      `;
    }

    // Reports Page (Admin)
    function renderReportsPage() {
      const activeTeachers = teachers.filter(t => t.status === 'active').length;
      const inactiveTeachers = teachers.filter(t => t.status === 'inactive').length;
      const subjectCounts = teachers.reduce((acc, t) => {
        if (t.subject) {
          acc[t.subject] = (acc[t.subject] || 0) + 1;
        }
        return acc;
      }, {});

      return `
      <div class="animate-fadeIn" >
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Status Distribution -->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Distribusi Status Guru</h3>
            </div>
            <div class="p-6">
              <div class="flex items-center justify-center gap-8 mb-6">
                <div class="text-center">
                  <div class="w-24 h-24 rounded-full gradient-green flex items-center justify-center mb-3 mx-auto">
                    <span class="text-2xl font-bold text-white">${activeTeachers}</span>
                  </div>
                  <p class="text-sm text-slate-600">Guru Aktif</p>
                </div>
                <div class="text-center">
                  <div class="w-24 h-24 rounded-full gradient-orange flex items-center justify-center mb-3 mx-auto">
                    <span class="text-2xl font-bold text-white">${inactiveTeachers}</span>
                  </div>
                  <p class="text-sm text-slate-600">Non-aktif</p>
                </div>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-4 overflow-hidden">
                <div class="h-full gradient-green" style="width: ${teachers.length > 0 ? (activeTeachers / teachers.length * 100) : 0}%"></div>
              </div>
              <p class="text-xs text-slate-500 text-center mt-2">${teachers.length > 0 ? Math.round(activeTeachers / teachers.length * 100) : 0}% guru aktif</p>
            </div>
          </div>

          <!-- Subject Distribution -->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Distribusi Mata Pelajaran</h3>
            </div>
            <div class="p-6">
              ${Object.keys(subjectCounts).length === 0 ? `
                  <div class="text-center py-8">
                    <p class="text-slate-500">Belum ada data</p>
                  </div>
                ` : `
                  <div class="space-y-3">
                    ${Object.entries(subjectCounts).map(([subject, count], i) => `
                      <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full gradient-${['blue', 'purple', 'green', 'orange', 'pink', 'cyan'][i % 6]}"></div>
                        <span class="flex-1 text-sm text-slate-600">${subject}</span>
                        <span class="text-sm font-medium text-slate-800">${count} guru</span>
                      </div>
                    `).join('')}
                  </div>
                `}
            </div>
          </div>

          <!-- Summary Card -->
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Ringkasan Data</h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-50 rounded-xl">
                  <p class="text-2xl font-bold text-blue-600">${teachers.length}</p>
                  <p class="text-sm text-blue-600/70">Total Guru</p>
                </div>
                <div class="p-4 bg-green-50 rounded-xl">
                  <p class="text-2xl font-bold text-green-600">${activeTeachers}</p>
                  <p class="text-sm text-green-600/70">Guru Aktif</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-xl">
                  <p class="text-2xl font-bold text-orange-600">${inactiveTeachers}</p>
                  <p class="text-sm text-orange-600/70">Non-aktif</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-xl">
                  <p class="text-2xl font-bold text-purple-600">${Object.keys(subjectCounts).length}</p>
                  <p class="text-sm text-purple-600/70">Mata Pelajaran</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      `;
    }

    // Settings Page (Admin)
    function renderSettingsPage() {
      return `
      <div class="animate-fadeIn max-w-2xl" >
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Pengaturan Aplikasi</h3>
              <p class="text-sm text-slate-500 mt-1">Kelola pengaturan aplikasi Anda</p>
            </div>
            <div class="p-6 space-y-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Judul Aplikasi</label>
                <input type="text" id="settings-title" value="${config.app_title || defaultConfig.app_title}" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Nama Sekolah</label>
                <input type="text" id="settings-school" value="${config.school_name || defaultConfig.school_name}" class="input-modern w-full px-4 py-3 border border-slate-200 rounded-xl">
              </div>
              <button id="save-settings-btn" class="btn-primary px-6 py-3 rounded-xl text-white font-medium">
                Simpan Pengaturan
              </button>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mt-6">
            <div class="p-6 border-b border-slate-100">
              <h3 class="font-semibold text-slate-800">Informasi Akun Admin</h3>
            </div>
            <div class="p-6">
              <div class="flex items-center gap-4">
                <div class="w-16 h-16 gradient-blue rounded-2xl flex items-center justify-center text-white text-2xl font-bold">
                  ${currentUser ? currentUser.name.charAt(0).toUpperCase() : 'A'}
                </div>
                <div>
                  <p class="font-semibold text-slate-800">${currentUser ? currentUser.name : 'Administrator'}</p>
                  <p class="text-sm text-slate-500">${currentUser ? currentUser.email : 'admin@sekolah.id'}</p>
                  <span class="inline-flex mt-1 px-2 py-0.5 text-xs font-medium rounded-lg status-active text-white">Administrator</span>
                </div>
              </div>
              <div class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                <p class="text-sm text-blue-700">
                  <strong>Catatan:</strong> Hanya admin yang dapat membuat atau mengelola akun guru. Guru tidak dapat mendaftar sendiri.
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Modal for Add/Edit Teacher (Admin)
    function renderModal() {
      const teacher = modalMode === 'edit' ? editingItem : null;

      return `
      <div class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4" >
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90%] overflow-hidden animate-fadeIn">
          <div class="p-6 border-b border-slate-100 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-800">${modalMode === 'edit' ? 'Edit Data Guru' : 'Tambah Guru Baru'}</h3>
            <button id="close-modal" class="p-2 rounded-xl hover:bg-slate-100 transition-colors">
              <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div class="p-6 overflow-y-auto max-h-[60vh]">
            <form id="teacher-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap *</label>
                <input type="text" id="modal-name" value="${teacher?.name || ''}" placeholder="Nama lengkap" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">NIP (18 digit) *</label>
                  <input type="text" id="modal-nip" value="${teacher?.nip || ''}" placeholder="Contoh: 123456789012345678" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" maxlength="18" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Kelas *</label>
                  <select id="modal-class" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                    <option value="">Pilih Kelas</option>
                    <option value="1A" ${teacher?.class === '1A' ? 'selected' : ''}>Kelas 1A</option>
                    <option value="1B" ${teacher?.class === '1B' ? 'selected' : ''}>Kelas 1B</option>
                    <option value="1C" ${teacher?.class === '1C' ? 'selected' : ''}>Kelas 1C</option>
                    <option value="2A" ${teacher?.class === '2A' ? 'selected' : ''}>Kelas 2A</option>
                    <option value="2B" ${teacher?.class === '2B' ? 'selected' : ''}>Kelas 2B</option>
                    <option value="2C" ${teacher?.class === '2C' ? 'selected' : ''}>Kelas 2C</option>
                    <option value="3A" ${teacher?.class === '3A' ? 'selected' : ''}>Kelas 3A</option>
                    <option value="3B" ${teacher?.class === '3B' ? 'selected' : ''}>Kelas 3B</option>
                    <option value="3C" ${teacher?.class === '3C' ? 'selected' : ''}>Kelas 3C</option>
                    <option value="4A" ${teacher?.class === '4A' ? 'selected' : ''}>Kelas 4A</option>
                    <option value="4B" ${teacher?.class === '4B' ? 'selected' : ''}>Kelas 4B</option>
                    <option value="4C" ${teacher?.class === '4C' ? 'selected' : ''}>Kelas 4C</option>
                    <option value="5A" ${teacher?.class === '5A' ? 'selected' : ''}>Kelas 5A</option>
                    <option value="5B" ${teacher?.class === '5B' ? 'selected' : ''}>Kelas 5B</option>
                    <option value="5C" ${teacher?.class === '5C' ? 'selected' : ''}>Kelas 5C</option>
                    <option value="6A" ${teacher?.class === '6A' ? 'selected' : ''}>Kelas 6A</option>
                    <option value="6B" ${teacher?.class === '6B' ? 'selected' : ''}>Kelas 6B</option>
                    <option value="6C" ${teacher?.class === '6C' ? 'selected' : ''}>Kelas 6C</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Email *</label>
                  <input type="email" id="modal-email" value="${teacher?.email || ''}" placeholder="email@sekolah.id" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">No. Telepon *</label>
                  <input type="tel" id="modal-phone" value="${teacher?.phone || ''}" placeholder="08xxxxxxxxxx" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Mata Pelajaran *</label>
                  <select id="modal-subject" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                    <option value="">Pilih Mata Pelajaran</option>
                    <option value="Guru Kelas" ${teacher?.subject === 'Guru Kelas' ? 'selected' : ''}>Guru Kelas</option>
                    <option value="Pendidikan Agama Islam" ${teacher?.subject === 'Pendidikan Agama Islam' ? 'selected' : ''}>Pendidikan Agama Islam</option>
                    <option value="Bahasa Indonesia" ${teacher?.subject === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                    <option value="Bahasa Inggris" ${teacher?.subject === 'Bahasa Inggris' ? 'selected' : ''}>Bahasa Inggris</option>
                    <option value="Pendidikan Pancasila" ${teacher?.subject === 'Pendidikan Pancasila' ? 'selected' : ''}>Pendidikan Pancasila</option>
                    <option value="Matematika" ${teacher?.subject === 'Matematika' ? 'selected' : ''}>Matematika</option>
                    <option value="IPAS" ${teacher?.subject === 'IPAS' ? 'selected' : ''}>IPAS</option>
                    <option value="PJOK" ${teacher?.subject === 'PJOK' ? 'selected' : ''}>PJOK</option>
                    <option value="Bahasa Lampung" ${teacher?.subject === 'Bahasa Lampung' ? 'selected' : ''}>Bahasa Lampung</option>
                    <option value="Seni Rupa" ${teacher?.subject === 'Seni Rupa' ? 'selected' : ''}>Seni Rupa</option>
                    <option value="Seni Musik" ${teacher?.subject === 'Seni Musik' ? 'selected' : ''}>Seni Musik</option>
                    <option value="KKA" ${teacher?.subject === 'KKA' ? 'selected' : ''}>KKA</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Kata Sandi ${modalMode === 'add' ? '*' : ''}</label>
                  <input type="password" id="modal-password" value="${teacher?.password || ''}" placeholder="${modalMode === 'edit' ? 'Biarkan kosong untuk mempertahankan' : 'Kata sandi minimal 6 karakter'}" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" ${modalMode === 'add' ? 'required' : ''}>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Status Kepegawaian *</label>
                <select id="modal-status" class="input-modern w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm" required>
                  <option value="active" ${!teacher || teacher.status === 'active' ? 'selected' : ''}>Aktif</option>
                  <option value="inactive" ${teacher?.status === 'inactive' ? 'selected' : ''}>Non-aktif</option>
                </select>
              </div>
            </form>
          </div>
          <div class="p-6 border-t border-slate-100 flex justify-end gap-3 shrink-0">
            <button id="cancel-modal" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">Batal</button>
            <button id="save-teacher" class="btn-primary px-8 py-2.5 rounded-xl text-white font-medium shadow-lg hover:shadow-blue-200 transition-all">${modalMode === 'edit' ? 'Update Data' : 'Simpan Data'}</button>
          </div>
        </div>
        </div>
      `;
    }


    // CSV Handling Functions
    function downloadStudentTemplate() {
      const headers = ['Nama Lengkap', 'NISN', 'NIS', 'Jenis Kelamin (L/P)', 'Tanggal Lahir (YYYY-MM-DD)'];
      // Use semicolon for better Excel compatibility in many regions (including ID)
      const csvContent = headers.join(';') + '\n' +
        'Contoh Siswa;1234567890;1001;L;2015-05-20\n' +
        'Siswa Kedua;0987654321;1002;P;2015-08-15';

      // Attach BOM to force Excel to recognize UTF-8 and help with delimiter detection
      const blob = new Blob(['\uFEFF', csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'template_siswa.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    async function processCSVImport(file) {
      if (!window.dataSdk) {
        showToast('System Error: Data SDK not ready', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        let text = e.target.result;

        // Remove BOM if present
        if (text.charCodeAt(0) === 0xFEFF) {
          text = text.substr(1);
        }

        const lines = text.split('\n');
        let successCount = 0;
        let failCount = 0;

        // Skip header row
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim(); if (!line) continue; if (line.startsWith('sep=')) continue;

          const delimiter = line.includes(' ;') ? ';' : ','; const cols = line.split(delimiter).map(c => c.trim());

          if (cols.length < 5) { failCount++; continue; } const [name, nisn, nis, gender, dob] = cols; if (!name || !nisn || !nis
            || !dob) { failCount++; continue; } const studentData = {
              id: generateId(), type: 'student', student_name: name,
              student_nisn: nisn, student_nis: nis, student_gender: gender.toUpperCase() === 'L' ? 'L' : 'P', student_dob: dob,
              student_class: currentUser.class
            }; try { await window.dataSdk.create(studentData); successCount++; } catch (err) {
              console.error('Import error:', err); failCount++;
            }
        } if (successCount > 0) {
          showToast(`Berhasil mengimpor ${successCount} siswa.Gagal: ${failCount} `, 'success');
          render();
        } else {
          showToast('Gagal mengimpor data. Cek format file.', 'error');
        }
      };

      reader.readAsText(file);
    }

    function downloadScoreTemplate() {
      const headers = ['Nama Lengkap', 'NISN', 'Mata Pelajaran', 'Nilai Formatif', 'Nilai Sumatif', 'Nilai MID', 'Nilai PAS'];
      const csvContent = headers.join(';') + '\n' +
        'Contoh Siswa;1234567890;Matematika;80;85;75;80\n' +
        'Siswa Kedua;0987654321;Bahasa Indonesia;90;88;92;85';

      const blob = new Blob(['\uFEFF', csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'template_nilai.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    async function processScoreCSVImport(file) {
      if (!window.dataSdk) {
        showToast('System Error: Data SDK not ready', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        let text = e.target.result;
        if (text.charCodeAt(0) === 0xFEFF) text = text.substr(1);

        const lines = text.split('\n');
        let successCount = 0;
        let failCount = 0;

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const delimiter = line.includes(';') ? ';' : ',';
          const cols = line.split(delimiter).map(c => c.trim());

          if (cols.length < 3) { failCount++; continue; }
          const [name, nisn, subject, formatif, sumatif, mid, pas] = cols;

          const student = students.find(s => s.student_nisn === nisn || s.student_name === name);
          if (!student) { failCount++; continue; }

          const f = parseFloat(formatif) || 0;
          const s = parseFloat(sumatif) || 0;
          const m = parseFloat(mid) || 0;
          const p = parseFloat(pas) || 0;
          const raport = ((f * 2) + (s * 4) + (m * 2) + (p * 2)) / 10;

          const scoreData = {
            student_id: student.__backendId || student.id,
            score_subject: subject || 'Lainnya',
            score_formatif: f,
            score_sumatif: s,
            score_mid: m,
            score_pas: p,
            score_raport: raport.toFixed(1),
            score_value: raport.toFixed(1),
            score_teacher_class: currentUser?.class,
            type: 'score'
          };

          try {
            // Check for existing score to update
            const existing = scores.find(sc => sc.student_id === scoreData.student_id && sc.score_subject === scoreData.score_subject);
            if (existing) {
              scoreData.id = existing.id || existing.__backendId;
              scoreData.__backendId = existing.__backendId;
              await window.dataSdk.update(scoreData);
            } else {
              scoreData.id = generateId();
              await window.dataSdk.create(scoreData);
            }
            successCount++;
          } catch (err) {
            failCount++;
          }
        }

        if (successCount > 0) {
          showToast(`Berhasil mengimpor ${successCount} nilai. Gagal: ${failCount}`, 'success');
          render();
        } else {
          showToast('Gagal mengimpor data nilai.', 'error');
        }
      };
      reader.readAsText(file);
    }

    function exportScoreToCSV() {
      let classScores = scores.filter(s => s.score_teacher_class === currentUser?.class);
      if (filterSubject) {
        classScores = classScores.filter(s => s.score_subject === filterSubject);
      }

      const headers = ['Nama Siswa', 'NISN', 'Mata Pelajaran', 'Formatif', 'Sumatif', 'MID', 'PAS', 'Raport'];
      const csvContent = headers.join(';') + '\n' +
        classScores.map(sc => {
          const s = students.find(std => (std.__backendId || std.id) === sc.student_id);
          return [
            s?.student_name || 'Tidak Ditemukan',
            s?.student_nisn || '-',
            sc.score_subject,
            sc.score_formatif,
            sc.score_sumatif,
            sc.score_mid,
            sc.score_pas,
            sc.score_raport
          ].join(';');
        }).join('\n');

      const blob = new Blob(['\uFEFF', csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'data_nilai_siswa.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Print Attendance Report Function
    function printAttendanceReport(type, dateStr) {
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const schoolName = config.school_name || 'SDN 1 PONCOWATI';
      const teacherName = currentUser?.name || 'Guru Kelas';
      const className = currentUser?.class || '-';

      let title = '';
      let dateInfo = '';
      let tableHeader = '';
      let tableRows = '';
      let tableFooter = '';

      const date = new Date(dateStr);

      if (type === 'daily') {
        title = 'LAPORAN ABSENSI HARIAN SISWA';
        dateInfo = `Tanggal: ${formatDate(dateStr)} `;
        tableHeader = `
      <tr>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">No</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: left; background-color: #f3f4f6;">Nama Siswa</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">NISN</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">NIS</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">JK</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">Status</th>
          </tr>
      `;

        let totalH = 0, totalS = 0, totalI = 0, totalA = 0;

        tableRows = classStudents.map((s, idx) => {
          const att = attendances.find(a => a.student_id === (s.__backendId || s.id) && a.attendance_date ===
            dateStr);
          const status = att ? att.attendance_status : '';
          if (status === 'hadir') totalH++;
          else if (status === 'sakit') totalS++;
          else if (status === 'izin') totalI++;
          else if (status === 'alpa') totalA++;

          return `
      <tr>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${idx + 1}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: 600;">${s.student_name}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${s.student_nisn}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${s.student_nis || '-'}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${s.student_gender || '-'}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${status.toUpperCase() || '-'}</td>
            </tr>
      `;
        }).join('');

        tableFooter = `
      < tr style = "background-color: #f3f4f6; font-weight: bold;" >
            <td colspan="5" style="border: 1px solid #000; padding: 8px; text-align: right;">JUMLAH:</td>
            <td style="border: 1px solid #000; padding: 8px; text-align: center;">
              H:${totalH} S:${totalS} I:${totalI} A:${totalA}
            </td>
          </tr>
      `;
      } else if (type === 'weekly') {
        title = 'LAPORAN ABSENSI MINGGUAN SISWA';
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));
        const weekDates = [];
        for (let i = 0; i < 6; i++) {
          const next = new Date(monday);
          next.setDate(monday.getDate() + i);
          weekDates.push(next.toISOString().split('T')[0]);
        }
        dateInfo = `Minggu: ${formatDate(weekDates[0])} s / d ${formatDate(weekDates[5])} `;
        tableHeader = `
      <tr>
            <th rowspan="2" style="border: 1px solid #000; padding: 5px; text-align: center; background-color: #f3f4f6; font-size: 10px;">Nama Siswa</th>
            <th rowspan="2" style="border: 1px solid #000; padding: 5px; text-align: center; background-color: #f3f4f6; font-size: 10px;">NISN</th>
            <th rowspan="2" style="border: 1px solid #000; padding: 5px; text-align: center; background-color: #f3f4f6; font-size: 10px;">NIS</th>
            <th colspan="6" style="border: 1px solid #000; padding: 5px; text-align: center; background-color: #f3f4f6; font-size: 10px;">Harian</th>
            <th colspan="4" style="border: 1px solid #000; padding: 5px; text-align: center; background-color: #f3f4f6; font-size: 10px;">Jumlah</th>
          </tr>
      <tr>
        ${weekDates.map(dw => `<th style="border: 1px solid #000; padding: 3px; text-align: center; background-color: #f3f4f6; font-size: 9px;">${new Date(dw).toLocaleDateString('id-ID', { weekday: 'short' })}<br>${new Date(dw).getDate()}</th>`).join('')}
        <th style="border: 1px solid #000; padding: 3px; text-align: center; background-color: #f3f4f6; font-size: 9px; width: 20px;">H</th>
        <th style="border: 1px solid #000; padding: 3px; text-align: center; background-color: #f3f4f6; font-size: 9px; width: 20px;">S</th>
        <th style="border: 1px solid #000; padding: 3px; text-align: center; background-color: #f3f4f6; font-size: 9px; width: 20px;">I</th>
        <th style="border: 1px solid #000; padding: 3px; text-align: center; background-color: #f3f4f6; font-size: 9px; width: 20px;">A</th>
      </tr>
    `;
        tableRows = classStudents.map((s, idx) => {
          let h = 0, s1 = 0, i = 0, a = 0;
          const cells = weekDates.map(dw => {
            const att = attendances.find(a => a.student_id === (s.__backendId || s.id) && a.attendance_date === dw);
            const status = att ? att.attendance_status : '';
            if (status === 'hadir') h++;
            else if (status === 'sakit') s1++;
            else if (status === 'izin') i++;
            else if (status === 'alpa') a++;
            return `<td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px;">${status ? status.charAt(0).toUpperCase() : '-'}</td>`;
          }).join('');

          return `
            <tr>
              <td style="border: 1px solid #000; padding: 4px; text-align: left; font-weight: 600; font-size: 10px;">${s.student_name}</td>
              <td style="border: 1px solid #000; padding: 4px; text-align: center; font-size: 9px;">${s.student_nisn}</td>
              <td style="border: 1px solid #000; padding: 4px; text-align: center; font-size: 9px;">${s.student_nis || '-'}</td>
              ${cells}
              <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px; font-weight: bold; background-color: #fcfcfc;">${h}</td>
              <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px; font-weight: bold; background-color: #fcfcfc;">${s1}</td>
              <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px; font-weight: bold; background-color: #fcfcfc;">${i}</td>
              <td style="border: 1px solid #000; padding: 3px; text-align: center; font-size: 9px; font-weight: bold; background-color: #fcfcfc;">${a}</td>
            </tr>
          `;
        }).join('');
      } else if (type === 'monthly') {
        const monthName = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
        title = 'LAPORAN ABSENSI BULANAN SISWA';
        dateInfo = `Bulan: ${monthName}`;
        tableHeader = `
          <tr>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">No</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: left; background-color: #f3f4f6;">Nama Siswa</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">NISN</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">NIS</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">H</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">S</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">I</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">A</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">Total</th>
            <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">%</th>
          </tr>
        `;

        const year = date.getFullYear();
        const month = date.getMonth();
        tableRows = classStudents.map((s, idx) => {
          const studentAtts = attendances.filter(a => a.student_id === (s.__backendId || s.id) && new Date(a.attendance_date).getMonth() === month && new Date(a.attendance_date).getFullYear() === year);
          const h = studentAtts.filter(a => a.attendance_status === 'hadir').length;
          const s1 = studentAtts.filter(a => a.attendance_status === 'sakit').length;
          const i = studentAtts.filter(a => a.attendance_status === 'izin').length;
          const a = studentAtts.filter(a => a.attendance_status === 'alpa').length;
          const total = h + s1 + i + a;
          const pct = total > 0 ? Math.round((h / total) * 100) : 0;
          return `
            <tr>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${idx + 1}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: 600;">${s.student_name}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center; font-size: 11px;">${s.student_nisn}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center; font-size: 11px;">${s.student_nis || '-'}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${h}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${s1}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${i}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center;">${a}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #fcfcfc;">${total}</td>
              <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${pct}%</td>
            </tr>
          `;
        }).join('');
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        < html >

      <head>
        <title>Cetak Absensi - ${schoolName}</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

          @page {
            size: portrait;
            margin: 15mm;
          }

          body {
            font-family: 'Inter', sans-serif;
            padding: 0;
            color: #000;
            font-size: 12px;
          }

          .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px double #000;
            padding-bottom: 10px;
          }

          .school-name {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
          }

          .report-title {
            font-size: 14px;
            font-weight: bold;
            margin: 5px 0;
            text-decoration: underline;
          }

          .meta-grid {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
          }

          .meta-left p,
          .meta-right p {
            margin: 2px 0;
          }

          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: auto;
          }

          .footer {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
          }

          .sig-box {
            width: 220px;
            text-align: center;
          }

          .sig-space {
            height: 60px;
          }

          .sig-name {
            font-weight: bold;
            text-decoration: underline;
          }

          @media print {
            .no-print {
              display: none;
            }
          }
        </style>
      </head>

      <body>
        <div class="header">
          <h1 class="school-name">${schoolName}</h1>
          <div class="report-title">${title}</div>
        </div>
        <div class="meta-grid">
          <div class="meta-left">
            <p><strong>Kelas:</strong> ${className}</p>
            <p><strong>Wali Kelas:</strong> ${teacherName}</p>
          </div>
          <div class="meta-right" style="text-align: right;">
            <p><strong>${dateInfo}</strong></p>
            <p>Dicetak: ${new Date().toLocaleString('id-ID', { dateStyle: 'medium' })}</p>
          </div>
        </div>
        <table>
          <thead>${tableHeader}</thead>
          <tbody>${tableRows}</tbody>
          <tfoot>${tableFooter}</tfoot>
        </table>
        <div class="footer">
          <div class="sig-box">
            <p>Mengetahui,</p>
            <p>Kepala Sekolah</p>
            <div class="sig-space"></div>
            <p class="sig-name">( ........................................ )</p>
          </div>
          <div class="sig-box">
            <p>${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
            </p>
            <p>Guru Kelas,</p>
            <div class="sig-space"></div>
            <p class="sig-name">${teacherName}</p>
          </div>
        </div>
        <script>
          window.onload = () => {
            window.print();
          };
        <\/script>
      </body>
    </html >
        `);
      printWindow.document.close();
    }

    function printScoreReport(type) {
      const classStudents = students.filter(s => (s.type === 'student' || !s.type) && s.student_class === currentUser?.class);
      const schoolName = config.school_name || 'SDN 1 PONCOWATI';
      const teacherName = currentUser?.name || 'Guru Kelas';
      const className = currentUser?.class || '-';
      const subjects = ['Pendidikan Agama Islam', 'Pendidikan Agama Kristen', 'Pendidikan Agama Katholik', 'Bahasa Indonesia', 'Bahasa Inggris', 'Pendidikan Pancasila', 'Matematika', 'IPAS', 'PJOK', 'Bahasa Lampung', 'Seni Rupa', 'Seni Musik', 'KKA'];

      let title = 'LAPORAN NILAI SISWA';
      if (type === 'nh' || type === 'formatif') title = 'LAPORAN NILAI FORMATIF / HARIAN';
      else if (type === 'sumatif') title = 'LAPORAN NILAI SUMATIF LINGKUP MATERI';
      else if (type === 'mid') title = 'LAPORAN NILAI SUMATIF TENGAH SEMESTER (MID)';
      else if (type === 'pas') title = 'LAPORAN NILAI SUMATIF AKHIR SEMESTER (PAS)';
      else if (type === 'raport') title = 'REKAPITULASI NILAI RAPORT';

      let tableHeader = `
        <tr>
          <th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6;">No</th>
          <th style="border: 1px solid #000; padding: 8px; text-align: left; background-color: #f3f4f6;">Nama Siswa</th>
          ${subjects.map(sub => `<th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f3f4f6; font-size: 10px;">${sub}</th>`).join('')}
        </tr>
        `;

      let tableRows = classStudents.map((s, idx) => {
        const studentId = s.__backendId || s.id;
        return `
        <tr>
            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${idx + 1}</td>
            <td style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: 600;">${s.student_name}</td>
            ${subjects.map(sub => {
          const score = scores.find(sc => sc.student_id === studentId && sc.score_subject === sub);
          let val = '-';
          if (type === 'nh' || type === 'formatif') val = score?.score_formatif || '-';
          else if (type === 'sumatif') val = score?.score_sumatif || '-';
          else if (type === 'mid') val = score?.score_mid || '-';
          else if (type === 'pas') val = score?.score_pas || '-';
          else if (type === 'raport') val = score?.score_raport || '-';
          return `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${val}</td>`;
        }).join('')
          }
          </tr>
        `;
      }).join('');

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
        <head>
          <title>Cetak Nilai - ${schoolName}</title>
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
            @page { size: landscape; margin: 10mm; }
            body { font-family: 'Inter', sans-serif; font-size: 10px; }
            .header { text-align: center; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 10px; }
            .school-name { font-size: 18px; font-weight: bold; margin: 0; text-transform: uppercase; }
            .report-title { font-size: 14px; font-weight: bold; margin: 5px 0; text-decoration: underline; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .meta { margin-bottom: 10px; }
            .footer { margin-top: 30px; display: flex; justify-content: space-between; }
            .sig-box { width: 200px; text-align: center; }
            .sig-space { height: 50px; }
            .sig-name { font-weight: bold; text-decoration: underline; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1 class="school-name">${schoolName}</h1>
            <div class="report-title">${title}</div>
          </div>
          <div class="meta">
            <p><strong>Kelas:</strong> ${className} | <strong>Guru:</strong> ${teacherName}</p>
          </div>
          <table>
            <thead>${tableHeader}</thead>
            <tbody>${tableRows}</tbody>
          </table>
          <div class="footer">
            <div class="sig-box">
              <p>Mengetahui,</p>
              <p>Kepala Sekolah</p>
              <div class="sig-space"></div>
              <p class="sig-name">( ........................................ )</p>
            </div>
            <div class="sig-box">
              <p>${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p>Guru Kelas,</p>
              <div class="sig-space"></div>
              <p class="sig-name">${teacherName}</p>
            </div>
          </div>
          <script>
            window.onload = () => { window.print(); };
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    function closeModal() {
      showModal = false;
      editingItem = null;
      render();
    }

    function updateSidebarActive() {
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.page === currentPage) {
          item.classList.add('active');
        }
      });
    }

    function updateBreadcrumb() {
      const titleEl = document.getElementById('page-title');
      const breadcrumbEl = document.getElementById('breadcrumb-current');
      const title = currentUserType === 'guru' ? getGuruPageTitle() : getPageTitle();

      if (titleEl) titleEl.textContent = title;
      if (breadcrumbEl) breadcrumbEl.textContent = title;
    }

    // Initialize app when DOM is ready

    // Local Data SDK Implementation (Fallback)
    /**
    * LocalDataSdk
    * A lightweight SDK that mimics the external dataSdk interface but uses localStorage for persistence.
    * This ensures the application works in standalone mode.
    */
    class LocalDataSdk {
      constructor() {
        this.storageKey = 'sdn1_poncowati_data';
        this.listeners = [];
        this.data = this._loadData();
      }

      /**
      * Loads data from localStorage safely.
      * @private
      * @returns {Array} The loaded data array or an empty array on failure.
      */
      _loadData() {
        try {
          const data = localStorage.getItem(this.storageKey);
          if (!data) return [];

          try {
            return JSON.parse(data);
          } catch (parseError) {
            console.error('Data corrupted, resetting storage:', parseError);
            // Backup corrupted data just in case
            localStorage.setItem(this.storageKey + '_corrupt_backup', data);
            return [];
          }
        } catch (e) {
          console.error('Failed to access localStorage:', e);
          if (typeof showToast === 'function') {
            showToast('Gagal memuat data lokal. Pastikan cookies/storage diaktifkan.', 'error');
          }
          return [];
        }
      }

      /**
      * Saves current data to localStorage.
      * Handles quota exceeded errors.
      * @private
      */
      _saveData() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.data));
          this._notifyListeners();
        } catch (e) {
          console.error('Failed to save data to localStorage', e);
          if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
            if (typeof showToast === 'function') {
              showToast('Penyimpanan penuh! Hapus beberapa data lama.', 'error');
            }
          } else {
            if (typeof showToast === 'function') {
              showToast('Gagal menyimpan data. Terjadi kesalahan sistem.', 'error');
            }
          }
        }
      }

      _notifyListeners() {
        this.listeners.forEach(listener => listener.onDataChanged(this.data));
      }

      /**
      * Initializes the SDK.
      * @param {Object} handler - The data handler object with onDataChanged method.
      */
      async init(handler) {
        if (handler && handler.onDataChanged) {
          this.listeners.push(handler);
          handler.onDataChanged(this.data);
        }
        return { isOk: true };
      }

      /**
      * Creates a new item.
      * @param {Object} item - The item to create.
      */
      async create(item) {
        const newItem = { ...item, __backendId: item.id || generateId() };
        this.data.push(newItem);
        this._saveData();
        return { isOk: true, data: newItem };
      }

      /**
      * Updates an existing item.
      * @param {Object} item - The item to update.
      */
      async update(item) {
        const index = this.data.findIndex(d => (d.__backendId || d.id) === (item.__backendId || item.id));
        if (index !== -1) {
          this.data[index] = { ...this.data[index], ...item };
          this._saveData();
          return { isOk: true, data: this.data[index] };
        }
        return { isOk: false, error: 'Item not found' };
      }

      /**
      * Deletes an item.
      * @param {Object} item - The item to delete.
      */
      async delete(itemOrCollection, id) {
        let itemId;
        if (typeof itemOrCollection === 'string') {
          itemId = id;
        } else {
          itemId = itemOrCollection.__backendId || itemOrCollection.id;
        }

        const initialLength = this.data.length;
        this.data = this.data.filter(d => (d.__backendId || d.id) !== itemId);

        if (this.data.length !== initialLength) {
          this._saveData();
          return { isOk: true };
        }
        return { isOk: false, error: 'Item not found' };
      }
    }

    // Initialize SDKs
    /**
    * Initializes the main application.
    * Sets up the Element SDK (if available) and the Data SDK (using LocalDataSdk as fallback).
    * This function should be called after the DOM is ready.
    */
    async function initApp() {
      console.log('Initializing Application...');

      // Initialize Element SDK
      if (window.elementSdk) {
        try {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (newConfig) => {
              config = { ...config, ...newConfig };
              updateAppTitle();
            },
            mapToCapabilities: (cfg) => ({
              recolorables: [
                {
                  get: () => cfg.primary_color || defaultConfig.primary_color,
                  set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
                },
                {
                  get: () => cfg.background_color || defaultConfig.background_color,
                  set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
                },
                {
                  get: () => cfg.text_color || defaultConfig.text_color,
                  set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
                }
              ],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (cfg) => new Map([
              ['app_title', cfg.app_title || defaultConfig.app_title],
              ['school_name', cfg.school_name || defaultConfig.school_name]
            ])
          });
          config = { ...defaultConfig, ...window.elementSdk.config };
        } catch (e) {
          console.error('Error initializing Element SDK:', e);
        }
      }

      // Initialize Data SDK
      if (window.dataSdk) {
        try {
          const result = await window.dataSdk.init(dataHandler);
          if (!result.isOk) {
            console.error('Failed to initialize data SDK', result.error);
            showToast('Gagal inisialisasi Data SDK. Aplikasi mungkin tidak berjalan optimal.', 'error');
          }
        } catch (e) {
          console.error('Exception during Data SDK init:', e);
          // Fallback if needed, though usually window.dataSdk implies availability
        }
      } else {
        // Fallback to LocalDataSdk
        console.log('External dataSdk not found. Using LocalDataSdk (Standalone Mode).');
        window.dataSdk = new LocalDataSdk();
        await window.dataSdk.init(dataHandler);
      }

      // Render initial state
      updateAppTitle();
      render();
    }
    // Start the application
    initApp();
  </script>
</body>

</html>